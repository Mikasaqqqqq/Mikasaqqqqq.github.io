

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Mikasa">
  <meta name="keywords" content="">
  
    <meta name="description" content="OI时期的做题记录，纪念一下，居然写的还蛮多的">
<meta property="og:type" content="article">
<meta property="og:title" content="OI做题记录">
<meta property="og:url" content="http://mikasaqqqqq.github.io/2025/06/22/OI%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="OI时期的做题记录，纪念一下，居然写的还蛮多的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://darkbzoj.cc/JudgeOnline/upload/201509/fb(1).jpg">
<meta property="og:image" content="https://i.loli.net/2018/07/28/5b5c0a750c492.png">
<meta property="article:published_time" content="2025-06-22T10:27:20.329Z">
<meta property="article:modified_time" content="2025-06-30T02:05:16.285Z">
<meta property="article:author" content="Mikasa">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://darkbzoj.cc/JudgeOnline/upload/201509/fb(1).jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>OI做题记录 - Hexo</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"mikasaqqqqq.github.io","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Mikasa blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/Image_1720062846071.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">OI做题记录</span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Mikasa
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-06-22 18:27" pubdate>
          2025年6月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          26k 字
        
      </span>
    

    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        

      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">OI做题记录</h1>
            
              <p id="updated-time" class="note note-info" style="display: none">
                
                  
                    本文最后更新于 2025-06-30T10:05:16+08:00
                  
                  

                
              </p>
            
            
              <div class="markdown-body">
                
                <h2 id="ZJOI2015-地震后的幻想乡"><a href="#ZJOI2015-地震后的幻想乡" class="headerlink" title="[ZJOI2015]地震后的幻想乡"></a>[ZJOI2015]地震后的幻想乡</h2><p>考虑到 $n \le 10$ ，所以大概率状压。 </p>
<p>题目要求的其实就是最小生成树上最大边在所有边中的排名。考虑当前排名为 $i$ ，排名向后一次产生的贡献为 $\frac{1}{m+1}$，概率为 $\frac{a_i}{C_{m}^{i}}$，其中 $a_i$ 为加入第 $i$ 小的边后不连通的方案数。</p>
<p>设 $f_{s,i}\ g_{s,i}$ 为加入第 $i$ 条边后连通或者不连通的方案数。</p>
<p>所以有 $f_{s,j}+g_{s,i}&#x3D; C_{m}^{i}$ 和 $ g_{s,i}&#x3D;\sum_{t\in s}\sum_{j&#x3D;0}^{cnt_t} f_{t,j}C_{cnt_{s-t}}^{i-j}$</p>
<p>第二个式子枚举 $t$ 时，会出现重复情况，所以还要钦定一个点在 $t$ 中</p>
<p>$Ans&#x3D;\frac{1}{m+1}\sum\frac{g_{s,i}}{C_{m}^{i}}$</p>
<h2 id="CF22E-Scheme"><a href="#CF22E-Scheme" class="headerlink" title="CF22E Scheme"></a>CF22E Scheme</h2><h4 id="构造题"><a href="#构造题" class="headerlink" title="构造题"></a>构造题</h4><p>题面：$n$个点，$n$条有向边，求让无图变成强联通图至少增加多少边并输出所加边</p>
<p>$solve$:很明显这是一个内向基环树森林，我们可以把它拆成若干条链，然后将这些链尾连向另一条的链首。我们可以$dfs$出每条链，其中简单环也要断成链</p>
<h2 id="LOJ6069-塔"><a href="#LOJ6069-塔" class="headerlink" title="LOJ6069 塔"></a>LOJ6069 塔</h2><h4 id="DP-矩阵乘法"><a href="#DP-矩阵乘法" class="headerlink" title="$DP$,矩阵乘法"></a>$DP$,矩阵乘法</h4><p>题面：现在有一条长 $L$ 的数轴，要在上面造 $n$ 座塔(高度$1-n$)。每座塔和前后两座塔的距离都要大于塔高，求方案数$mod\ m$。<br>$n\le100\  \ L,m\le 1e9$</p>
<p>$solve$:因为$L$很大，$n$比较小，先考虑塔之间紧密排列，设最大长度为$s\le n(n+1)$。所以$O(n^4)$求出$dp[i][j][k]$表示前$i$个塔，紧密排列长度为$j$，形成$k$个块的方案数，第一位滚调。$ans&#x3D;\sum_{i&#x3D;1}^sdp[n][i][1]*C_{n}^{L-i-1+n}$</p>
<p>令$l&#x3D;L-1+n,r&#x3D;L-1-s+n$，可以发现$r-l\le n^2$。所以我们可以通过矩阵快速幂求出$C_{0-n}^l$,然后递推法求出剩余部分。</p>
<p><a target="_blank" rel="noopener" href="https://loj.ac/s/1387212">code</a></p>
<h2 id="LOJ6039-珠宝"><a href="#LOJ6039-珠宝" class="headerlink" title="LOJ6039 珠宝"></a>LOJ6039 珠宝</h2><h4 id="背包-DP-，分治"><a href="#背包-DP-，分治" class="headerlink" title="背包$DP$，分治"></a>背包$DP$，分治</h4><p>题面：有$n$个物品，每个体积为$V_i$,价值为$C_i$，容积为$k$，求对于每个容积为$i(i\le k)$的最大价值。<br>$n\le1e6,k\le5e4,C\le300,V\le1e9$</p>
<p>$solve$:直接$0&#x2F;1$背包肯定是不行的，因为$C$很小，所以我们以$C$分类，然后按$V$从小到达求以下前缀和。</p>
<p>则有$dp_{i,j}&#x3D;dp_{i-1,j-i*k}+w_{i,k}$。</p>
<p>不难发现，$j$和$j-i*k$是在$mod\ i$意义下相等的，于是对于同一组我们还可使根据$mod \ i$的值进行分类<br>还能够发现这个$dp$<br>存在决策单调性，如果$j-k×i$比$j-p×i$($p&gt;k$)在$j$更优，那么对于更大的$j$来说$j-k×i$还是要优于$j-p×i$，因为$w_i$,$k$差分之后是递减的，$j-k×i$的增长速度快于$j-p×i$,所以我们直接分治即可</p>
<p>复杂度是$O(nclogn)$</p>
<p><a target="_blank" rel="noopener" href="https://loj.ac/s/1388155">code</a></p>
<h2 id="CF711D-Directed-Roads"><a href="#CF711D-Directed-Roads" class="headerlink" title="CF711D Directed Roads"></a>CF711D Directed Roads</h2><h4 id="基环树"><a href="#基环树" class="headerlink" title="基环树"></a>基环树</h4><p>题面：有$n$个点和$n$条边，第$i$条边从$i$连到$a_i$.每条边需要指定一个方向（无向边变为有向边）。问有多少种指定方向 的方案使得图中不出现环$(mod\ 1e9)$。</p>
<p>$solve$:对于非环边$m$条，每个环有$w_i$条边，$ans&#x3D;2^m*\Pi(2^{w_i}-2)$</p>
<h2 id="bzoj4481-线段游戏"><a href="#bzoj4481-线段游戏" class="headerlink" title="bzoj4481 线段游戏"></a>bzoj4481 线段游戏</h2><h4 id="二分图-set-DP-线段树"><a href="#二分图-set-DP-线段树" class="headerlink" title="二分图+$set$&#x2F;$DP+$线段树"></a>二分图+$set$&#x2F;$DP+$线段树</h4><p>题面：将一个长$n$数列分成没有逆序对的两个子序列，求方案数$mod\ 998244353$  $a_i\le n \le 2e5$</p>
<p>$solve1$:令$dp_{i,j}$表示不包括$a_i$的序列，最大的数为$j$的方案数。则有</p>
<p>$a_i$和$a_{i-1}$不在一个序列：（情况1）$dp_{i,a_{i-1}}&#x3D;\sum dp_{i-1,j}(j&lt;a_i)$</p>
<p>$a_i$和$a_{i-1}$在一个序列：（情况2）如果$a_i&lt;a_{i-1}$ 则$dp_{i,j}&#x3D;0$，（情况3）否则$dp_{i,j}&#x3D;dp_{i-1,j}$</p>
<p>很明显可以用线段树加速一下，对于情况2则把线段树清空。</p>
<p><a target="_blank" rel="noopener" href="https://darkbzoj.tk/submission/180471">code</a></p>
<p>$solve2$:我们把每对逆序对看作一条边，很明显就变成了一个二分图的黑白染色问题。然后我们又发现对于$i&lt;j&lt;k,p_i&gt;p_j&gt;p_k$是一定无解的。我们可以用$set$来维护当前每个集合的最大值，把所有最大值$&gt;p_i$的合并起来，答案就等于$2^{cnt}$,$cnt$为集合个数。</p>
<p><a target="_blank" rel="noopener" href="https://darkbzoj.tk/submission/180611">code</a></p>
<h2 id="CF1174F-Ehab-and-the-Big-Finale"><a href="#CF1174F-Ehab-and-the-Big-Finale" class="headerlink" title="CF1174F Ehab and the Big Finale"></a>CF1174F Ehab and the Big Finale</h2><h4 id="重链剖分，构造，交互题"><a href="#重链剖分，构造，交互题" class="headerlink" title="重链剖分，构造，交互题"></a>重链剖分，构造，交互题</h4><p>题面:这是一道交互题。<br>你有一棵$n(n\le2e5)$个节点的有根树，$1$号点是根节点。</p>
<p>这棵树中有一个隐藏的节点$x$，你需要通过询问把$x$找出来。<br>你可以进行如下两种询问：</p>
<p>1、$d\ u\ (1\le u\le n)$。交互库会返回节点$u$和$x$的距离。</p>
<p>2、$s\ u\ (1\le u\le n)$。交互库会返回从uuu到xxx的路径上第二个点的标号。</p>
<p>注意，你询问的$u$必须是$x$的祖先，否则会$Wrong Ans$。</p>
<p>你需要在不超过$36$次询问之内找出$x$。$x$是预先设定好的，不会随着询问而改变。</p>
<p>$solve$:观察到$36&#x3D;2log_22e5$，而且有是树上的修改，不难想到重链剖分。</p>
<p>我们一开始询问$d\ 1$来确定$x$的深度，然后跳到这个深度的重儿子$son$上，查询$d\ son$,然后将$son$跳到$x$和$son$的$lca$上，询问一次$s\ lca$，然后继续搜索。</p>
<p>对于$son$的深度不够的情况稍微，处理一下就好了。</p>
<p>最多有$log_2n$条重链，每条重链两次操作。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/69927679">code</a></p>
<h2 id="CF1375H-Set-Merging"><a href="#CF1375H-Set-Merging" class="headerlink" title="CF1375H Set Merging"></a>CF1375H Set Merging</h2><h4 id="构造，值域分块，分治"><a href="#构造，值域分块，分治" class="headerlink" title="构造，值域分块，分治"></a>构造，值域分块，分治</h4><p>题面：给定长度为 $n$ 的序列 $a$，最初有 $n$ 个集合 {$a_1$},{$a_2$}…,{$a_{n-1}$},{$a_n$}。$n\le2^{12},q\le2^{16}$</p>
<p>接下来给定 $q$ 个询问，每次询问给出 $l$,$r$ </p>
<p>你需要通过若干次操作制作出集合 {$a_l$,$a_{l+1}$…,$a_{r-1}$,$a_r$}。</p>
<p>操作是指：你可以合并两个集合 $A,B$ 但要满足 $max_{u \in A}u&lt;min_{v\in B}v$。</p>
<p>注意：操作过程中集合总数不能超过 $2.2*10_6$,合并后集合 $A,B$ 依然存在。</p>
<p>$solve$:我们发现$2.2*10^6\approx2^{21}&#x3D;2n\sqrt{q}$，所以可以想到把原序列对 $B$ 值域分块，并在每个块内按位置排序，那么每一个块都是原序列的子序列,对于一次询问 $l,r$ 我们每次将块内连续的一段取出来合并，需要 $O(\frac{n}{B})$次操作。<br>那么我们只需要考虑如何预处理即可。</p>
<p>对于一个序列$q$，我们将他按值域分治，每次将两个值域合并在一起。每次的合并的操作数为$O(|q|^2)$,所以总次数$T(B)&#x3D;T(\frac{B}{2})+O(B^2)-&gt;T(B)&#x3D;O(B^2)$</p>
<p>操作数为$O(\frac{nq}{B}+nB),$当$B&#x3D;\sqrt{q}$时有最小值$O(2n\sqrt{q})$</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/70005933">code</a></p>
<h2 id="CF321C-Ciel-the-Commander"><a href="#CF321C-Ciel-the-Commander" class="headerlink" title="CF321C Ciel the Commander"></a>CF321C Ciel the Commander</h2><h4 id="构造，点分治"><a href="#构造，点分治" class="headerlink" title="构造，点分治"></a>构造，点分治</h4><p>题面：一棵$n$个点的树，给每个树的权值为$1-26$,任意两个权值相同的点路径之间有至少一个权值比他小的点，构造方案。$n\le1e5$</p>
<p>solve: $log_21e5&lt;26$，所以考虑点分治，按照得到的重心顺序赋值。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/70068269">code</a></p>
<h2 id="bzoj4699-树上的最短路"><a href="#bzoj4699-树上的最短路" class="headerlink" title="bzoj4699 树上的最短路"></a>bzoj4699 树上的最短路</h2><h4 id="Dij-线段树，路径压缩"><a href="#Dij-线段树，路径压缩" class="headerlink" title="Dij,线段树，路径压缩"></a>Dij,线段树，路径压缩</h4><p>题面：这是一棵$n$个节点的带权<br>树。现在，要用最快的速度赶往目标节点$k$。下水道有一些塌陷，这导致主干路的某一段路径可以通过该塌陷到另一条路径。对于一个塌陷，我们用$(L_1,R_1,L_2,R_2,c)$来描述，即对于主干路上$L_1$到$R_1$路径上的任意节点$x$，$L_2$到$R_2$路径上的任意节点$y$，都可以在$c$的时间从$x$走到$y$。因为不知道自己所在的到底是哪个节点，所以要求出每个节<br>点到目标节点$K$的最短距离。$n\le 250000,k\le 100000$</p>
<p>$solve$:有两个主要的关键点。</p>
<p>$(1).$每个塌陷只会被第一个使用他的点使用，所以我们把使用过的全部删除就好。在做$Dij$维护树上点和塌陷。<br>对于用塌陷更新，因为每次取出的都是当前$priority\ queue$的最小值，所以每个点当被取出或被塌陷更新之后，它就不会被更新了，即$dis$确定了，所以我们考虑模仿的并查集的路径压缩，每次都将$f_x$指向未确定$dis$且深度最大的祖先。</p>
<p>$(2).$如何求出经过一个点的所有塌陷。令$st_x$和$en_x$表示$x$子树（包括$x$）$dfs$序的最小值和最大值,并用$vector\ g_x$来存所有经过$x$的塌陷。对于$x&#x3D;LCA(L_2,R_2)$，直接加入$g_x$即可。<br>对于$st_x\le dfs_{L_2}\le en_x,dfs_{R_2}&gt;en_x$以及$st_x\le dfs_{R_2}\le en_x,L_2\le st_x$也加入$g_x$中。我们可以维护两棵线段树，一个维护$L_2$的最小值，一个维护$R_2$的最大值，每次取出就好，取完删除即可。</p>
<p>其实可以把所有树边也看作塌陷的，只不过我打完了才知道</p>
<p>做的时候$Dij$的$continue$打成$break$全$WA$了，求$LCA,max(log_2n)$取了$25,T$了，调了两天。代码又丑又慢</p>
<p><a target="_blank" rel="noopener" href="https://darkbzoj.tk/submission/181920">code</a></p>
<h2 id="P8096-USACO22JAN-Drought-G"><a href="#P8096-USACO22JAN-Drought-G" class="headerlink" title="P8096 [USACO22JAN] Drought G"></a>P8096 [USACO22JAN] Drought G</h2><h4 id="DP"><a href="#DP" class="headerlink" title="DP"></a>DP</h4><p>题面:$N$ 头奶牛$(0≤N≤100)$排成一行，第 $i$ 头奶牛的饥饿度为一个非负整数<br>$h_i$。降低奶牛饥饿度的唯一方法是选择两头相邻的奶牛 $i$ 和 $i+1$令她们的饥饿度各减少 1。将奶牛喂至所有的奶牛都具有相同的非负饥饿度。第 $i$ 头奶牛的饥饿度 $hi$ 至多为 $H_i(0≤Hi≤10000)$。<br>计算符合上述上界的 $N$元组 $[h_1,h_2,…,h_N]$的数量，答案对 $1e9+7$。</p>
<p>$solve$:考虑$N$的奇偶性和反向操作,但$N$为偶数时，直接$f_i$表示但前最后一个高度为$i$即可，奇数是多枚举一层初始高度即可。$O(nH_{max})-O(n^2H_{max})$</p>
<h2 id="P8097-USACO22JAN-Farm-Updates-G"><a href="#P8097-USACO22JAN-Farm-Updates-G" class="headerlink" title="P8097 [USACO22JAN] Farm Updates G"></a>P8097 [USACO22JAN] Farm Updates G</h2><h4 id="并查集-文字游戏"><a href="#并查集-文字游戏" class="headerlink" title="并查集 文字游戏"></a>并查集 文字游戏</h4><p>题面：$N$ 个农场$(1≤N≤10^5)$，最初，这些农场之间没有道路连接，并且每个农场都在活跃地生产牛奶。$Q$ 次更新操作$(0≤Q≤2⋅10^5)$</p>
<p>$(D\ x)$ 停用一个活跃的农场 $x$，使其不再生产牛奶。</p>
<p>$(A\ x\ y)$ 在两个活跃的农场 $x$ 和 $y$ 之间添加一条道路。</p>
<p>$(R\ e)$ 删除之前添加的第 $e$ 条道路。</p>
<p>一个农场 $x$ 如果正在活跃地生产牛奶，或者可以通过一系列道路到达另一个活跃的农场，则称之为一个「有关的」农场。对于每个农场 $x$，计算最大的 $i(0≤i≤Q)$，使得农场 $x$ 在第 $i$ 次更新后是有关的。</p>
<p>$solve:$因为每次加边都是把两个活跃的农场连起来，所以主要影响答案的是删边操作。发现这点后即直接反向操作，拿个并查集随便维护就好了。</p>
<h2 id="P8098-USACO22JAN-Tests-for-Haybales-G"><a href="#P8098-USACO22JAN-Tests-for-Haybales-G" class="headerlink" title="P8098 [USACO22JAN] Tests for Haybales G"></a>P8098 [USACO22JAN] Tests for Haybales G</h2><h4 id="dfs"><a href="#dfs" class="headerlink" title="$dfs$"></a>$dfs$</h4><p>题面：有一个有序整数数组 $x_1≤x_2≤⋯≤x_N,(1≤N≤10^5)$，和一个整数 $K$。你不知道这个数组以及 $K$，但你知道对于每个索引 $i$ 使得 $x_{j_i}≤x_i+K$ 的最大索引 $j_i$。保证有 $i≤j_i$ 以及 $j_1≤j_2≤⋯≤j_N$。</p>
<p>构造任意一个数组以及整数 $K$ 与该信息一致。构造需要满足对于所有 $i$ 有$ 0≤x_i≤10^{18}$，并且 $1≤K≤10^{18}$。</p>
<p>$solve:$我们建立一棵有 $n+1$ 个节点的树，对于每个节点，与父亲 $j_i+1$连一条边。易知根为 $n+1$。由于 $j_i$ 不降，可以发现层次高的节点编号一定大于层次低的节点。并且 $j_i+1$层次恰好比 $i$ 大 $1$。</p>
<p>又根据构造条件，$x_{j_i+1}$ 应当大约比 $x_i$ 大 $K$。由此可以猜测每个节点权值为 $d_iK+x’(0≤x’&lt;K)$。令$x’&#x3D;K-dfn_i$<br>由于 $x’≥0$，令 $K≥n+1$即可。</p>
<h2 id="P2481-SDOI2010-代码拍卖会"><a href="#P2481-SDOI2010-代码拍卖会" class="headerlink" title="P2481 [SDOI2010]代码拍卖会"></a>P2481 [SDOI2010]代码拍卖会</h2><h4 id="计数-dp"><a href="#计数-dp" class="headerlink" title="计数$dp$"></a>计数$dp$</h4><p>题面：求长度为$n(n\le 10^{18})$且$mod\ p(p\le500)\equiv0$的数的方案数，每位数在$1-9$之间且高到低单调不下降，对答案$mod\ 999911659$</p>
<p>$solve:$虽然$tag$是数位$dp$但实际上只是借用其思想。考虑$112334&#x3D;111111+1111+111+1$，所以每个数可以看作若干个$111\ldots11$相加的到。</p>
<p>令$g_i$表示$11\ldots111\equiv i$的个数，我们发现在$1-p+1$中肯定存在一个循环节，暴力找到循环节就好。</p>
<p>令$f_{i,j,k}$表示前$i-1$个余数，选了$j$个$11\ldots11$串，余数为$k$的方案数。$f_{i+1,j+l,k+(l\ast l)mod\ p}&#x3D;\sum C_{l}^{g_i+l-1}\ast f_{i,j,k}$</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/70945421">code</a></p>
<h2 id="CF708C-Centroids"><a href="#CF708C-Centroids" class="headerlink" title="CF708C Centroids"></a>CF708C Centroids</h2><h4 id="树型-dp-，换根法，二次扫描"><a href="#树型-dp-，换根法，二次扫描" class="headerlink" title="树型$dp$，换根法，二次扫描"></a>树型$dp$，换根法，二次扫描</h4><p>题面：给定一颗树，你有一次将树改造的机会，改造的意思是删去一条边，再加入一条边，保证改造后还是一棵树。请问有多少点可以通过改造,该点每个子树的大小都不大于$\dfrac{n}{2}$。</p>
<p>$solve:$显然这是一道换根$dp$，每个点至多有一个子树的$siz&gt;\dfrac{n}{2}$，所以我们用$g_x$表示以$x$根的子树中$siz\le\dfrac{n}{2}$的$siz$的最大值,$son_x$记录是哪棵子树。但我们发现在第二次扫描中父亲节点$u$的$son_x$可能会是子结点$v$，所以还要存一个次大值。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/70984572">code</a></p>
<h2 id="P6419-Kamp"><a href="#P6419-Kamp" class="headerlink" title="P6419 Kamp"></a>P6419 Kamp</h2><h4 id="换根"><a href="#换根" class="headerlink" title="换根"></a>换根</h4><p>题面：一颗树$n$个点$n−1$条边，经过每条边都要花费一定的时间，任意两个点都是联通的。有$K$个人(分布在$K$个不同的点）要集中到一个点举行聚会。<br>聚会结束后需要一辆车从举行聚会的这点出发，把这$K$个人分别送回去。<br>请你回答，对于$i&#x3D;1-n$，如果在第$i$个点举行聚会，司机最少需要多少时间把 $K$个人都送回家。</p>
<p>$solve:$有个坑，就是送完最后一个人不用回到根节点的。$siz_x$表示$x$的子树中有几个家，$g_x$表示以$x$的子树送完所有人回到$x$的路程，$dis_{x,0&#x2F;1}$表示从$x$开始到一个家的最长&#x2F;次长链，$son_x$表示最长链上$x$的子结点，$f_x$表示从$x$送完所有人回到$x$的路程。</p>
<p>然后分类讨论$(u-&gt;v)$</p>
<p>$$<br>\begin{aligned}<br>1.&amp;siz_v&#x3D;0:f_v&#x3D;f_u+2\ast w,dis_{v,0}&#x3D;dis_{u,0}+w\</p>
<p>2.&amp;siz_v&#x3D;k:f_v&#x3D;g_v\</p>
<p>3.&amp;(1)son_u\not&#x3D; v,dis_{u,0}+w&gt;dis_{v,0}\<br>&amp;(2)son_u&#x3D;v,dis_{u,1}+w&gt;dis{v,0}\<br>&amp;(3)son_u\not&#x3D;v,dis_{u,0}+w&gt;dis_{v,1}\<br>&amp;(4)dis_{u,1}+w&gt;dis_{v,1}<br>\end{aligned}<br>$$</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/71010329">code</a></p>
<h2 id="LG4148-简单题"><a href="#LG4148-简单题" class="headerlink" title="LG4148 简单题"></a>LG4148 简单题</h2><h4 id="KD-tree-替罪羊树重构"><a href="#KD-tree-替罪羊树重构" class="headerlink" title="$KD\ tree$, 替罪羊树重构"></a>$KD\ tree$, 替罪羊树重构</h4><p>题面：你有一个$N×N$的棋盘，每个格子内有一个整数，初始时的时候全部为 $0$ ，现在需要维护两种操作：</p>
<p> $1\ x\ y\ A\ 1≤x,y≤N,A$ 是正整数。将格子$(x,y)$里的数字加上 $A$。</p>
<p> $2\ x_1\ y_1\ x_2\ y_2,1≤x1≤x2≤N,1\le y_1\le y_2\le N$。输出 $x_1, y_1, x_2, y_2$这个矩形内的数字和</p>
<p> $3$ 无 终止程序</p>
<p>$solve:KDT+$替罪羊树重构，但好像不重构跑得更快。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/71512731">code</a></p>
<h2 id="LZ4297-选班长"><a href="#LZ4297-选班长" class="headerlink" title="LZ4297 选班长"></a>LZ4297 选班长</h2><h4 id="set-启发式合并"><a href="#set-启发式合并" class="headerlink" title="$set$启发式合并"></a>$set$启发式合并</h4><p>题面：编号为 $1-n$ 的 $n$ 个人，初始有 $m$ 对认识关系，对于两对关系 $(i,j)\ (i,k)$ 且 $i&lt;j,k$ ，这 $j,k$ 可以建立认识关系。但不存在可以拓展的关系后，每个人选 $1-n$ 中的一个数，有认识关系的人不能选同一个数，求方案数，对 $998244353$ 取模。</p>
<p>$solve:$用 $set_i$ 维护第 $i$ 个人认识的比他大的人的编号，然后将  $set_i$ 和 $set_{s_i.begin()}$ 启发式合并。答案为 $\Pi(n-set_i.size())$</p>
<h2 id="LG2472-蜥蜴"><a href="#LG2472-蜥蜴" class="headerlink" title="LG2472 蜥蜴"></a>LG2472 蜥蜴</h2><h4 id="网络流"><a href="#网络流" class="headerlink" title="网络流"></a>网络流</h4><p>题面：$n \times m$ 的方格，每个格子有个高度 $h_{i,j}$ 。有些方格上有蜥蜴，蜥蜴的平面跳跃距离不超过 $d$ ，每次跳跃后，原来的格子高度会 $-1$ ，且任意两只蜥蜴不会在同一个方格上。求最少有多少只蜥蜴跳不出平面。</p>
<p>$solve:$</p>
<p>$1.$ 把每个方格拆成入点和出点，连一条流量为 $h_{i,j}$ 的边。</p>
<p>$2.$ 每个点的出点向它可以跳到的点连一条流量为 $inf$ 的边。</p>
<p>$3.$ 把源点 $S$ 向每个有蜥蜴的点连一条流量为 $1$ 的边。</p>
<p>$4$. 把可以跳出平面的点向汇点 $T$ 连一条流量为 $inf$ 的边。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72672622">code</a></p>
<h2 id="LG8252-NOI-Online-2022-提高组-讨论"><a href="#LG8252-NOI-Online-2022-提高组-讨论" class="headerlink" title="LG8252 [NOI Online 2022 提高组] 讨论"></a>LG8252 [NOI Online 2022 提高组] 讨论</h2><h4 id="排序，模拟"><a href="#排序，模拟" class="headerlink" title="排序，模拟"></a>排序，模拟</h4><p>题面：有 $n$ 个人正在打模拟赛，模拟赛有 $n$ 道题目。</p>
<p>定义第 $i$ 个人会的题目的集合为 $S_i$，即当 $S_x \cap S_y\not&#x3D; \varnothing  \land S_x \not\subseteq S_y \wedge S_y \not\subseteq S_x$时，第 $x$ 人和第 $y$ 人会讨论）</p>
<p>为了让模拟赛的效果更好，希望你可以找出一对会讨论的人或判断不存在。</p>
<p>$solve:$ 把每个 $S$ 从大到小排序，用 $pos_i$ 记录第 $i$ 个数最后出现的位置，每次取出有记录的 $pos_i$ 的最小值 $j$ ，判断当前集合 $S$ 与 $S_i$ 是否满足 $S \subseteq S_i$，不是的话直接输出答案，否则就更新 $pos$ 数组。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72623055">code</a></p>
<h2 id="LG8251-NOI-Online-2022-提高组-丹钓战"><a href="#LG8251-NOI-Online-2022-提高组-丹钓战" class="headerlink" title="LG8251 [NOI Online 2022 提高组] 丹钓战"></a>LG8251 [NOI Online 2022 提高组] 丹钓战</h2><h4 id="主席树，ST表，二分"><a href="#主席树，ST表，二分" class="headerlink" title="主席树，ST表，二分"></a>主席树，ST表，二分</h4><p>题面：有 $n$ 个二元组 $(a_i, b_i)$ ，编号为 $1$ 到 $n$。</p>
<p>有一个初始为空的栈 $S$ ，向其中加入元素 $(a_i, b_i)$ 时，先不断弹出栈顶元素直至栈空或栈顶元素 $(a_j , b_j)$ 满足 $a_i \neq a_j$ 且 $b_i &lt; b_j$ ，然后再将其加入栈中。</p>
<p>如果一个二元组入栈后栈内只有这一个元素，则称该二元组是“成功的”。</p>
<p>有 qq 个询问 $[l_i, r_i]$ ，表示若将编号在 $[l_i, r_i]$ 中的二元组按编号从小到大依次入栈，会有多少个二元组是“成功的”。</p>
<p>询问之间相互独立。</p>
<p>$solve:$ 发现从 $1$ 开始是和从 $l$ 开始这 $r-l+1$ 个数的弹出顺序是没有太大改变的。所以先从 $1$ 模拟一下，记录 $c_i$ 表示第 $i$ 个数是被第 $c_i$ 个数弹出的。然后用 $f_i$ 表示满足 $c_j \le i $ 且 $j\in [f_i,i-1]$的最小值，用二分加 $ST$ 表。对于每个询问就是求 $\sum_l^r f_i\le l$，用主席数维护就可以了。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72599812">code</a></p>
<h2 id="CF246E-Blood-Cousins-Return"><a href="#CF246E-Blood-Cousins-Return" class="headerlink" title="CF246E  Blood Cousins Return"></a>CF246E  Blood Cousins Return</h2><h4 id="启发式合并"><a href="#启发式合并" class="headerlink" title="启发式合并"></a>启发式合并</h4><p>题面：给定一片森林，每次询问一个节点的 $K-Son$ 共有个多少不同的名字。一个节点的 $K-Son$ 即为在该节点子树内的，深度是该节点深度加 $K$ 的节点。</p>
<p>$solve:$ 用 $set\ d_x$ 来存深度为 $x$ 的所用名字，启发式合并一波。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72094011">code</a></p>
<h2 id="LG1646-国家集训队-happiness"><a href="#LG1646-国家集训队-happiness" class="headerlink" title="LG1646 [国家集训队]happiness"></a>LG1646 [国家集训队]happiness</h2><h4 id="网络流-1"><a href="#网络流-1" class="headerlink" title="网络流"></a>网络流</h4><p>题面：高一一班的座位表是个 $n\times m$ 的矩阵，经过一个学期的相处，每个同学和前后左右相邻的同学互相成为了好朋友。这学期要分文理科了，每个同学对于选择文科与理科有着自己的喜悦值，而一对好朋友如果能同时选文科或者理科，那么他们又将收获一些喜悦值。<br>作为计算机竞赛教练的 $scp$ 大老板，想知道如何分配可以使得全班的喜悦值总和最大。</p>
<p>$solve:$ 最小割，割完和源点 $S$ 相连的选文科，和汇点 $T$ 相连的选理科。对于每对选同样科目 $(x,y)$ 的建一个新点并向 $x$和$y$ 连一条流量为 $inf$ 的边，向起点或汇点连一条流量为喜悦度的边。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72761001">code</a></p>
<h2 id="LG5934-最小生成树"><a href="#LG5934-最小生成树" class="headerlink" title="LG5934 最小生成树"></a>LG5934 最小生成树</h2><h4 id="网络流-2"><a href="#网络流-2" class="headerlink" title="网络流"></a>网络流</h4><p>题面：给定一个边带正权的连通无向图 $G&#x3D;(V,E)$，其中 $N&#x3D;∣V∣,M&#x3D;∣E∣$ ， $N$ 个点从 $1$ 到 $N$ 依次编号，给定三个正整数 $u,v$ 和 $L(u≠v)$ ，假设现在加入一条边权为 $L$ 的边 $(u,v)$ ，那么需要删掉最少多少条边，才能够使得这条边既可能出现在最小生成树上，也可能出现在最大生成树上？</p>
<p>$solve:$非常有意思的 $trick$ ，对于可能在最小生成树上数会满足，除去边权 $\ge L$ 的边后， $u,v$ 两个节点不在连通，跑一下最小割就好了。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72820113">code</a></p>
<h2 id="LG1251-餐巾计划问题"><a href="#LG1251-餐巾计划问题" class="headerlink" title="LG1251 餐巾计划问题"></a>LG1251 餐巾计划问题</h2><h4 id="费用流"><a href="#费用流" class="headerlink" title="费用流"></a>费用流</h4><p>题目：一个餐厅在相继的 $N$ 天里,每天需用的餐巾数不尽相同。假设第 $i$ 天需要 $r_i$ 块餐巾 $(i&#x3D;1,2,…,N)$ 。餐厅可以购买新的餐巾,每块餐巾的费用为 $p$ 分;或者把旧餐巾送到快洗部,洗一块需 $m$ 天,其费用为 $f$ 分;或者送到慢洗部,洗一块需 $n$ 天 $(n&gt;m)$ ,其费用为 $s$ 分 $(s&lt;f)$。</p>
<p>每天结束时,餐厅必须决定将多少块脏的餐巾送到快洗部,多少块餐巾送到慢洗部,以及多少块保存起来延期送洗。但是每天洗好的餐巾和购买的新餐巾数之和,要满足当天的需求量。</p>
<p>试设计一个算法为餐厅合理地安排好 $N$ 天中餐巾使用计划,使总的花费最小。编程找出一个最佳餐巾使用计划。</p>
<p>$solve:$ 把每天拆点成早上 $x_i$ 和 晚上 $y_i$ ，早上接收毛巾，晚上处理毛巾。</p>
<p>$1.S \rightarrow x_i\ (inf,p)$ </p>
<p>$2.x_i \rightarrow T \ (r_i,0)$ </p>
<p>$3.y_i \rightarrow y_{i+1}\ (inf,0)$ </p>
<p>$4.y_i \rightarrow y_{i+m}\ (inf,f)$</p>
<p>$5.y_i \rightarrow y_{i+n}\ (inf,s)$</p>
<p>$6.S \rightarrow y_i\ (r_i,0)$</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/72978437">code</a></p>
<h2 id="LG3159-CQOI2012-交换棋子"><a href="#LG3159-CQOI2012-交换棋子" class="headerlink" title="LG3159 [CQOI2012]交换棋子"></a>LG3159 [CQOI2012]交换棋子</h2><h4 id="费用流-1"><a href="#费用流-1" class="headerlink" title="费用流"></a>费用流</h4><p>题面：有一个 $n$ 行 $m$ 列的黑白棋盘，你每次可以交换两个相邻格子（相邻是指有公共边或公共顶点）中的棋子，最终达到目标状态。要求第 $i$ 行第 $j$ 列的格子只能参与 $m_{i,j}$ 次交换。</p>
<p>$solve:$ 非常好的建模题目。把题目转变为忽略白棋，黑棋走到目标位置，对于已经在目标位置的黑棋看作白棋。把点拆成两个点 $x,y$。</p>
<p><strong>1.起点 $S$ 向初始黑棋 $x$ 连流量 $1$ 费用 $0$ 的边</strong></p>
<p><strong>2.目标点黑棋 $y$ 向终点 $T$ 连流量为 $1$ 费用为 $0$ 的边</strong></p>
<p><strong>3. $x$ 向 $y$ 连一条流量为 $m&#x2F;2$ 费用为 $0$ 的边</strong></p>
<p><strong>对于起始或目标点，且 $m$ 为奇数时，再多连一条；流量为 $1$ 的边</strong></p>
<p><strong>4. 八连通图流量 $inf$ 费用 $0$</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/73303496">code</a></p>
<h2 id="LG3980-NOI2008-志愿者招募"><a href="#LG3980-NOI2008-志愿者招募" class="headerlink" title="LG3980 [NOI2008] 志愿者招募"></a>LG3980 [NOI2008] 志愿者招募</h2><h4 id="网络流-3"><a href="#网络流-3" class="headerlink" title="网络流"></a>网络流</h4><p>题面：一个项目需要 $n$ 天才能完成，其中第 $i$ 天至少需要 $a_i$ 个人。布布通过了解得知，一共有 $m$ 类志愿者可以招募。其中第 $i$ 类可以从第 $s_i$ 天工作到第 $t_i$ 天，招募费用是每人 $c_i$ 元。设计一种最优的招募方案。</p>
<p>$solve:$ 非常巧妙的见图方法。</p>
<p><strong>1. $i\rightarrow i+1$ 连一条流量为 $inf-a_i$ ，费用为 $0$ 的边</strong></p>
<p><strong>2. $s_i \rightarrow t_i+1$ 连一条流量为 $inf$ ，费用为 $c_i$ 的边</strong></p>
<p><strong>3. $S \rightarrow 1\ \ n+1 \rightarrow T$连一条流量为 $inf$ 费用为 $0$ 的边</strong></p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/73446340">code</a></p>
<h2 id="LG4542营救皮卡丘"><a href="#LG4542营救皮卡丘" class="headerlink" title="LG4542营救皮卡丘"></a>LG4542营救皮卡丘</h2><h4 id="网络流，-Floyd"><a href="#网络流，-Floyd" class="headerlink" title="网络流，$Floyd$"></a>网络流，$Floyd$</h4><p>题面：有 $N$ 个据点，据点之间存在 $M$ 条双向道路。据点分别从 $1$ 到 $N$ 标号。小智一行 $K$ 人从真新镇出发，营救被困在 $N$ 号据点的皮卡丘。一开始 $K$ 个人都在 $0$ 号点。</p>
<p>要想摧毁 $K$ 号据点，必须按照顺序先摧毁 $1$ 到 $K-1$ 号据点，小智一行任何一个人经过 $K$ 号据点即认为 $K$ 号据点被摧毁。被摧毁的据点依然是可以被经过的。</p>
<p>$K$ 个人是可以分头行动的，只要有任何一个人在 $K-1$ 号据点被摧毁之后，经过 $K$ 号据点，$K $号据点就被摧毁了。显然的，只要 $N$ 号据点被摧毁，皮卡丘就得救了。</p>
<p>野外的道路是不安全的，因此小智一行希望在摧毁 $N$ 号据点救出皮卡丘的同时，使得 $K$ 个人所经过的道路的长度总和最少。</p>
<p>$solve:$ 拆点，拆成入点 $x$ 和出点 $y$, 然后求出 $d_{i,j}$ 表示 $i$ 到 $j$ 不经过超过 $j$ 的点的最短路。</p>
<p>$1. S\rightarrow x\ (1,0)\ \ \ y \rightarrow T\ (1,0)$</p>
<p>$2. S \rightarrow 1\ (k,0)$</p>
<p>$3.x_i\rightarrow y_j\ (1,d_{i,j})$</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/73754770">code</a></p>
<h2 id="LG4287双倍回文"><a href="#LG4287双倍回文" class="headerlink" title="LG4287双倍回文"></a>LG4287双倍回文</h2><h4 id="manacher"><a href="#manacher" class="headerlink" title="$manacher$"></a>$manacher$</h4><p>题面：记字符串 $w$ 的倒置为 $w^R$。<br>如果 $x$ 能够写成的 $ww^Rww^R$ 形式，则称它是一个“双倍回文”。<br>对于给定的字符串，计算它的最长双倍回文子串的长度。</p>
<p>$solve:$ 对于每次 $i$ 如果 $ i&lt;mr $且 $ i-p_i&lt;mid $ 那么就可以构成一个双倍回文，注意这里的 $p_i$ 是直接从 $mid$ 转移来的，还没有拓展过的。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/74540775">code</a></p>
<h2 id="LG4234-最小差值生成树"><a href="#LG4234-最小差值生成树" class="headerlink" title="LG4234 最小差值生成树"></a>LG4234 最小差值生成树</h2><h4 id="LCT"><a href="#LCT" class="headerlink" title="$LCT$"></a>$LCT$</h4><p>从小到大加边，动态维护路径上的最小值就好了。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/74600926">code</a></p>
<h2 id="LG2542-航线规划"><a href="#LG2542-航线规划" class="headerlink" title="LG2542 航线规划"></a>LG2542 航线规划</h2><h4 id="LCT-1"><a href="#LCT-1" class="headerlink" title="$LCT$"></a>$LCT$</h4><p>LCT维护双连通分量模板</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/74852720">code</a></p>
<h2 id="LG4219-大融合"><a href="#LG4219-大融合" class="headerlink" title="LG4219 大融合"></a>LG4219 大融合</h2><h4 id="LCT-2"><a href="#LCT-2" class="headerlink" title="$LCT$"></a>$LCT$</h4><p>LCT维护子树大小模板,维护虚链和实链&amp;虚链的大小</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/74852720">code</a></p>
<h2 id="LG3703-树点染色"><a href="#LG3703-树点染色" class="headerlink" title="LG3703 树点染色"></a>LG3703 树点染色</h2><h4 id="LCT-线段树"><a href="#LCT-线段树" class="headerlink" title="$LCT$ 线段树"></a>$LCT$ 线段树</h4><p>因为每次染色都是节点到 $root$ 而且颜色都不一样，很类似与 $LCT$ 的 $access$ 操作。然后用线段树来维护到 $root$ 上虚链的个数即可。</p>
<p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/record/75526371">code</a></p>
<h2 id="Loj588-我们的-CPU-遭到攻击"><a href="#Loj588-我们的-CPU-遭到攻击" class="headerlink" title="Loj588 我们的 CPU 遭到攻击"></a>Loj588 我们的 CPU 遭到攻击</h2><h4 id="LCT-3"><a href="#LCT-3" class="headerlink" title="$LCT$"></a>$LCT$</h4><p>用 $LCT$ 来维护每条实链黑点到 $top$的路径总和，以及虚链的路径和。但我们发现在 $reverse$ 之后点到 $top$ 的路径长度也发生了 $reverse$，所以每次维护 $0&#x2F;1$ 表示 $reverse$ 前&#x2F;后的答案。</p>
<p><a target="_blank" rel="noopener" href="https://loj.ac/s/1462576">code</a></p>
<h2 id="LZ3299-决战"><a href="#LZ3299-决战" class="headerlink" title="LZ3299 决战"></a>LZ3299 决战</h2><h4 id="fhq-treap-树剖"><a href="#fhq-treap-树剖" class="headerlink" title="$fhq-treap$ 树剖"></a>$fhq-treap$ 树剖</h4><p>主要难题在 $reverse$ 操作上，线段树不行但 $fhq_treap$ 可以，所以用 $fhq-treap$ 来维护重链，每次询问把链合并然后分解回去。</p>
<p><a target="_blank" rel="noopener" href="http://192.168.11.163:8008/showsource.php?id=93094">code</a></p>
<h2 id="Uoj207-共价大爷游长沙"><a href="#Uoj207-共价大爷游长沙" class="headerlink" title="Uoj207 共价大爷游长沙"></a>Uoj207 共价大爷游长沙</h2><h4 id="LCT-4"><a href="#LCT-4" class="headerlink" title="$LCT$"></a>$LCT$</h4><p>非常巧妙的判断方法。给每条路径赋个随机权值，然后计算子树异或和就好了。</p>
<p><a target="_blank" rel="noopener" href="https://uoj.ac/submission/552062">code</a></p>
<h2 id="LG3426-POI2005-SZA-Template"><a href="#LG3426-POI2005-SZA-Template" class="headerlink" title="LG3426 [POI2005]SZA-Template"></a>LG3426 [POI2005]SZA-Template</h2><p><del>好久没写了</del><br>我们先 $KMP$ 求出 $nex_i$ 。然后设 $dp_i$ 表示前缀的答案。<br>显然，对于当前的 $i$ 只有 $i$ 和 $dp_{nex_i}$ 两个取值。<br>取 $dp_{nex_i}$ 当且仅当存在 $dp_j&#x3D; dp_{nex_i}$ 且 $i-nex_i&lt;&#x3D;j$。 </p>
<h2 id="BZOJ4262-Sum"><a href="#BZOJ4262-Sum" class="headerlink" title="[BZOJ4262] Sum"></a>[BZOJ4262] Sum</h2><p><img src="https://darkbzoj.cc/JudgeOnline/upload/201509/fb(1).jpg" srcset="/img/loading.gif" lazyload></p>
<p>先 $Sum$ 转化为前缀的形式 $\sum\limits_{i&#x3D;1}\limits^{r_2}\sum\limits_{j&#x3D;l_1}\limits^{r_1}{\max{A_{j \sim i}}-\min {A_{j \sim i}}}-\sum\limits_{i&#x3D;1}\limits^{l_2-1}\sum\limits_{j&#x3D;l_1}\limits^{r_1}{\max{A_{j \sim i}}-\min{A_{j \sim i}{}}}$ 。</p>
<p>那其实就是维护  $\sum\limits_{i&#x3D;1}\limits^{r}\sum\limits_{j&#x3D;l_1}\limits^{r_1}\max{A_{j \sim i}}$。</p>
<p>先把询问离线，考虑用单调栈维护每个 $A_i$ 的贡献区间，用线段树维护一下后缀的最大值，但因为要求的是 $\sum\limits_{i&#x3D;1}\limits^{r}$ 所有后缀的值，所以线段树上要维护一下历史版本和（<del><strong>俺不会</strong></del>）。</p>
<p>对于每个标记 $tag$ 维护四个值 </p>
<p>$tl$：当前标记最早修改的历史版本时间戳。</p>
<p>$tr$：当前标记最晚修改的历史版本时间戳。</p>
<p>$val$：$tr$所对应的修改值。</p>
<p>$sum$：$tl\sim tr-1$ 所有修改的 $val$ 和。</p>
<p>对于线段树维护四个值</p>
<p>$tim$：区间当前版本时间戳。</p>
<p>$val$：区间当前版本最大值之和。</p>
<p>$sum$：区间 $1\sim tim-1$ 所有历史版本 $val$ 之和。</p>
<p>合并代码（<strong><del>自己理解一下</del></strong>）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tags</span><br>&#123;<br>	<span class="hljs-type">int</span> val,tl,tr; ll sum;<br><br>	tags <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> tags &amp;a) <span class="hljs-type">const</span><br>	&#123; <br>		<span class="hljs-keyword">if</span>(val==<span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> a;<br>		<span class="hljs-keyword">return</span> (tags)&#123;a.val,tl,a.tr,sum+a.sum<span class="hljs-number">+1ll</span>*val*(a.tl-tr)&#125;;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span> </span>&#123; val=<span class="hljs-number">-1</span>; &#125;<br><br>&#125;tag[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Tree</span><br>&#123;<br>	<span class="hljs-type">int</span> tim,len;<br>	ll val,sum;<br><br>	Tree <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> tags &amp;a) <span class="hljs-type">const</span><br>	&#123;<br>		<span class="hljs-keyword">return</span> (Tree)&#123;a.tr,len,<span class="hljs-number">1ll</span>*a.val*len,sum+a.sum*len+(a.tl-tim)*val&#125;;<br>	&#125;<br><br>	Tree <span class="hljs-keyword">operator</span> + (<span class="hljs-type">const</span> Tree &amp;a) <span class="hljs-type">const</span><br>	&#123;<br>		<span class="hljs-type">int</span> t=<span class="hljs-built_in">max</span>(tim,a.tim);<br>		ll s=sum+a.sum+(t-tim)*val+(t-a.tim)*a.val;<br>		<span class="hljs-keyword">return</span> (Tree)&#123;t,len+a.len,val+a.val,s&#125;;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span><br><span class="hljs-function">	</span>&#123;<br>		len=<span class="hljs-number">1</span>;tim=val=sum=<span class="hljs-number">0</span>;<br>	&#125;<br><br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>],res;<br></code></pre></td></tr></table></figure>

<h2 id="P5212-SubString-（非强制在线做法）"><a href="#P5212-SubString-（非强制在线做法）" class="headerlink" title="P5212 SubString  （非强制在线做法）"></a>P5212 SubString  （非强制在线做法）</h2><p>给定一个字符串 <code>init</code>，要求支持两个操作：</p>
<ul>
<li><p>在当前字符串的后面插入一个字符串。</p>
</li>
<li><p>询问字符串 $s$ 在当前字符串中出现了几次。(作为连续子串)</p>
</li>
</ul>
<p>模拟赛题目，赛时没有强制在线，用 $AC$ 自动机+线段树合并水出来了。</p>
<p>原题强制在线 $SAM+LCT$ ，菜狗本人不会<del>也不想敲</del>。赛时线段树合并空间开小了与暴力同分。</p>
<p>先考虑没有修改的情况就是裸的 $AC$ 自动机在 $Fail$ 树上跑。</p>
<p>加上修改后，对于每个修改加一个时间戳 $tim$ ，显然这次修改只会对时间戳 $\ge tim$ 的询问产生贡献，所以对 $Fail$ 树上的点维护一棵权值线段树维护每个时间戳的贡献，不断向上合并就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e6</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> q,n,m,rt[N],tot,cnt,ch[N][<span class="hljs-number">26</span>],fail[N];<br><span class="hljs-type">int</span> now,lst[N],a[N],id[N],in[N],ans[N];<br><span class="hljs-type">char</span> s[N],init[N],add[N];<br>vector&lt;<span class="hljs-type">int</span>&gt;g[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> ls,rs,sum;<br>&#125;t[N*<span class="hljs-number">20</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!k) k=++tot;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> t[k].sum++,<span class="hljs-built_in">void</span>();<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">insert</span>(t[k].ls,l,mid,x);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">insert</span>(t[k].rs,mid<span class="hljs-number">+1</span>,r,x);<br>	t[k].sum=t[t[k].ls].sum+t[t[k].rs].sum;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!k||l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> t[k].sum;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(t[k].ls,l,mid,x,y)+<span class="hljs-built_in">query</span>(t[k].rs,mid<span class="hljs-number">+1</span>,r,x,y);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Merge</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!x||!y) <span class="hljs-keyword">return</span> x|y;<br>	t[x].sum+=t[y].sum;<br>	t[x].ls=<span class="hljs-built_in">Merge</span>(t[x].ls,t[y].ls);<br>	t[x].rs=<span class="hljs-built_in">Merge</span>(t[x].rs,t[y].rs);<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Fail</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	queue&lt;<span class="hljs-type">int</span>&gt;q;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">26</span>;i++)<br>		<span class="hljs-keyword">if</span>(ch[<span class="hljs-number">0</span>][i]) q.<span class="hljs-built_in">push</span>(ch[<span class="hljs-number">0</span>][i]);<br>	<span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>())<br>	&#123;<br>		<span class="hljs-type">int</span> x=q.<span class="hljs-built_in">front</span>();q.<span class="hljs-built_in">pop</span>();<br>		in[fail[x]]++;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">26</span>;i++)<br>		&#123;<br>			<span class="hljs-keyword">if</span>(ch[x][i])<br>			&#123;<br>				fail[ch[x][i]]=ch[fail[x]][i];<br>				q.<span class="hljs-built_in">push</span>(ch[x][i]);<br>			&#125;<br>			<span class="hljs-keyword">else</span> ch[x][i]=ch[fail[x]][i];<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">DP</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		x=ch[x][init[i]-<span class="hljs-string">&#x27;A&#x27;</span>];<br>		<span class="hljs-keyword">if</span>(x) <span class="hljs-built_in">insert</span>(rt[x],<span class="hljs-number">1</span>,n,a[i]);<br>	&#125;<br>	queue&lt;<span class="hljs-type">int</span>&gt;q;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=cnt;i++)<br>		<span class="hljs-keyword">if</span>(!in[i]) q.<span class="hljs-built_in">push</span>(i);<br>	<span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>())<br>	&#123;<br>		<span class="hljs-type">int</span> x=q.<span class="hljs-built_in">front</span>();q.<span class="hljs-built_in">pop</span>();<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;g[x].<span class="hljs-built_in">size</span>();i++)<br>			ans[g[x][i]]=<span class="hljs-built_in">query</span>(rt[x],<span class="hljs-number">1</span>,n,<span class="hljs-number">1</span>,lst[g[x][i]]);<br>		<span class="hljs-keyword">if</span>(fail[x]!=<span class="hljs-number">0</span>)<br>		&#123;<br>			rt[fail[x]]=<span class="hljs-built_in">Merge</span>(rt[fail[x]],rt[x]);<br>			<span class="hljs-keyword">if</span>(!(--in[fail[x]])) q.<span class="hljs-built_in">push</span>(fail[x]);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> len;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,init<span class="hljs-number">+1</span>);<br>	n=<span class="hljs-built_in">strlen</span>(init<span class="hljs-number">+1</span>);<br>	now=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) a[i]=now;<br>	<span class="hljs-keyword">while</span>(q--)<br>	&#123;<br>		<span class="hljs-type">char</span> op[<span class="hljs-number">10</span>];<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,op);<br>		<span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;A&#x27;</span>)<br>		&#123;<br>			now++;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,add<span class="hljs-number">+1</span>);<br>			len=<span class="hljs-built_in">strlen</span>(add<span class="hljs-number">+1</span>);<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=len;i++)<br>				a[n+i]=now,init[n+i]=add[i];<br>			n+=len;<br>		&#125;<br>		<span class="hljs-keyword">else</span> <br>		&#123;<br>			m++;lst[m]=now;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%s&quot;</span>,s<span class="hljs-number">+1</span>);<br>			len=<span class="hljs-built_in">strlen</span>(s<span class="hljs-number">+1</span>);<br>			<span class="hljs-type">int</span> x=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=len;i++)<br>			&#123;<br>				<span class="hljs-keyword">if</span>(!ch[x][s[i]-<span class="hljs-string">&#x27;A&#x27;</span>]) ch[x][s[i]-<span class="hljs-string">&#x27;A&#x27;</span>]=++cnt;<br>				x=ch[x][s[i]-<span class="hljs-string">&#x27;A&#x27;</span>];<br>			&#125;<br>			g[x].<span class="hljs-built_in">push_back</span>(m);<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">Fail</span>();<span class="hljs-built_in">DP</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,ans[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF997E-Good-Subsegments-CF526F-Pudding-Monsters"><a href="#CF997E-Good-Subsegments-CF526F-Pudding-Monsters" class="headerlink" title="CF997E Good Subsegments &#x2F; CF526F Pudding Monsters"></a>CF997E Good Subsegments &#x2F; CF526F Pudding Monsters</h2><p>$CF997E$ 是 $CF526F$ 的加强版。只写 $CF997E$。</p>
<p>去年做这题的时候没有理解透彻，最近有想起来重新做了一遍，又收获了一点新东西。</p>
<p>一段区间 $[l,r]$ 的值域连续的充要条件就是 $\max-\min&#x3D;r-l$ ，所以就是要求满足 $\max-\min+l-r&#x3D;0$ 的区间个数。有因为 $\max -\min-l+r\ge 0$ 。所以其实就是要求最小值是 $0 $ 的个数。</p>
<p>考虑把询问离线，按右端点从小到大排序。对于每个右端点，用线段树和单调栈可以维护后缀的 $\max-\min+l-r$ 的值，这样就可以求出固定了右端点的合法区间个数。但题目要求的是 $[l,r]$ 中的所有合法区间，所以还要维护下一历史版本和，每次右端点右移的时候线段树的 $tim$ 就加 $1$ 。</p>
<p>下面是一些实现的细节</p>
<ul>
<li><p>对于线段树我们并不用真正去记录最小值是 $0$ 的个数。因为 $[r,r]$ 这个区间的值一定是为 $0$ 的，维护最小值个数就好了。</p>
</li>
<li><p>时间的 $tim$ 在 $pushdown$ 的时候只下传到存在最小值的区间，因为只有那些区间的当前版本有贡献</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,q,a[N];<br><span class="hljs-type">int</span> st1[N],st2[N],top1,top2;<br>ll ans[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> l,r,id;<br>    <span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (node &amp;b) &#123;<span class="hljs-keyword">return</span> r&lt;b.r;&#125;<br>&#125;que[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Tree</span><br>&#123;<br>	ll ans;<br>	<span class="hljs-type">int</span> c,mn,tim,tag;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> val)</span></span>&#123; t[k].tag+=val;t[k].mn+=val;&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add_tim</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> val)</span></span>&#123; t[k].ans+=<span class="hljs-number">1ll</span>*val*t[k].c;t[k].tim+=val;&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].c=<span class="hljs-number">1</span>;t[k].mn=l;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(t[k].tag!=<span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-built_in">Add_tag</span>(k&lt;&lt;<span class="hljs-number">1</span>,t[k].tag);<span class="hljs-built_in">Add_tag</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,t[k].tag);<br>		t[k].tag=<span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(t[k].tim)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(t[k&lt;&lt;<span class="hljs-number">1</span>].mn==t[k].mn) <span class="hljs-built_in">Add_tim</span>(k&lt;&lt;<span class="hljs-number">1</span>,t[k].tim);<br>		<span class="hljs-keyword">if</span>(t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].mn==t[k].mn) <span class="hljs-built_in">Add_tim</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,t[k].tim);<br>		t[k].tim=<span class="hljs-number">0</span>;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].mn=<span class="hljs-built_in">min</span>(t[k&lt;&lt;<span class="hljs-number">1</span>].mn,t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].mn);<br>	t[k].c=(t[k&lt;&lt;<span class="hljs-number">1</span>].mn==t[k].mn ? t[k&lt;&lt;<span class="hljs-number">1</span>].c:<span class="hljs-number">0</span>)+(t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].mn==t[k].mn ? t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].c:<span class="hljs-number">0</span>);<br>	t[k].ans=t[k&lt;&lt;<span class="hljs-number">1</span>].ans+t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].ans;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Add_tag</span>(k,val),<span class="hljs-built_in">void</span>();<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y,val);<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y,val);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> t[k].ans;<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y)+<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;que[i].l,&amp;que[i].r),que[i].id=i;<br>	<span class="hljs-built_in">sort</span>(que<span class="hljs-number">+1</span>,que<span class="hljs-number">+1</span>+q);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,now=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-built_in">Add_tag</span>(<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>);<br>		<span class="hljs-keyword">while</span>(top1&amp;&amp;a[st1[top1]]&lt;a[i]) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,st1[top1<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,st1[top1],a[i]-a[st1[top1]]),top1--;<br>		<span class="hljs-keyword">while</span>(top2&amp;&amp;a[st2[top2]]&gt;a[i]) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,st2[top2<span class="hljs-number">-1</span>]<span class="hljs-number">+1</span>,st2[top2],a[st2[top2]]-a[i]),top2--;<br>		st1[++top1]=i;st2[++top2]=i;<br>		<span class="hljs-built_in">Add_tim</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">while</span>(now&lt;=q&amp;&amp;que[now].r==i)<br>			ans[que[now].id]=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,que[now].l,que[now].r),now++;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,ans[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1693C-Keshi-in-Search-of-AmShZ"><a href="#CF1693C-Keshi-in-Search-of-AmShZ" class="headerlink" title="CF1693C Keshi in Search of AmShZ"></a>CF1693C Keshi in Search of AmShZ</h2><p>正着搞比较难（<del>其实是不会</del>），考虑建反图。</p>
<p>$d_x$ 为 $n$ 到 $x$ 的最少天数。</p>
<p>考虑一个点 $x$ ，所有入边的 $d$ 值为 ${d_1,d_2,d_3,\dots,d_k}\ (d_1\le d_2 \dots \le d_k)$  </p>
<p>那么 $d_x&#x3D;\min\limits_{i&#x3D;1 \sim k}{d_i+k-i}+1$</p>
<p>回顾一下在 $Dij$ 的过程中每次都是从 $priority-queue$ 里面弹出最小值，所以不用考虑 ${d_1,d_2,d_3,\dots,d_k}$ 的排序，直接记录当前入度就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,in[N],dis[N],vis[N];<br>vector&lt;<span class="hljs-type">int</span>&gt;g[N];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x,y;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y),in[x]++,g[y].<span class="hljs-built_in">push_back</span>(x);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) dis[i]=m+n;<br>	priority_queue&lt;pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; &gt;q;<br>	dis[n]=<span class="hljs-number">0</span>;<br>	q.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">make_pair</span>(<span class="hljs-number">0</span>,n));<br>	<span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>())<br>	&#123;<br>		<span class="hljs-type">int</span> x=q.<span class="hljs-built_in">top</span>().second;q.<span class="hljs-built_in">pop</span>();<br>		<span class="hljs-keyword">if</span>(vis[x]) <span class="hljs-keyword">continue</span>;<br>		vis[x]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;g[x].<span class="hljs-built_in">size</span>();i++)<br>		&#123;<br>			<span class="hljs-type">int</span> y=g[x][i];<br>			<span class="hljs-keyword">if</span>(dis[y]&gt;dis[x]+in[y]) <br>				dis[y]=dis[x]+in[y],q.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">make_pair</span>(-dis[y],y));<br>			in[y]--;<br>		&#125;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,dis[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="CF325E-The-Red-Button"><a href="#CF325E-The-Red-Button" class="headerlink" title="CF325E The Red Button"></a>CF325E The Red Button</h2><p>手完了几组后发现奇数情况应该是 $-1$ 。</p>
<ul>
<li><p>考虑 $n&#x3D;2n’+1$ ， $n-1$ 和 $0$ 这两个点只有 $n’$ 可以到达，所以奇数情况一定无解。</p>
</li>
<li><p>考虑 $n&#x3D;2n’$ ，我们发现 $2i \equiv 2(i+n’)(mod \ n)$，所以 $i$ 和 $i+n’$ 这两个点是等价的，所以直接将整个序列划分成两个环，最后在合并这两个环就好了，维护一个 $nex$ 数组和并查集就好了。</p>
</li>
</ul>
<p>看了很久一直没有发现这个等价关系，果真是个菜狗</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,f[N],nex[N];<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123; <span class="hljs-keyword">return</span> x==f[x]? x:f[x]=<span class="hljs-built_in">find</span>(f[x]); &#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">if</span>(n&amp;<span class="hljs-number">1</span>) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;-1&quot;</span>);<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++) f[i]=i;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n/<span class="hljs-number">2</span>;i++)<br>		&#123;<br>			<span class="hljs-type">int</span> j=i+n/<span class="hljs-number">2</span>;<br>			nex[i]=i&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>;<br>			nex[j]=i&lt;&lt;<span class="hljs-number">1</span>;<br>			f[<span class="hljs-built_in">find</span>(i)]=f[<span class="hljs-built_in">find</span>(i&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>)];<br>			f[<span class="hljs-built_in">find</span>(j)]=f[<span class="hljs-built_in">find</span>(i&lt;&lt;<span class="hljs-number">1</span>)];<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n/<span class="hljs-number">2</span>;i++)<br>		&#123;<br>			<span class="hljs-type">int</span> j=i+n/<span class="hljs-number">2</span>;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-built_in">find</span>(i)!=<span class="hljs-built_in">find</span>(j))<br>			&#123;<br>				<span class="hljs-built_in">swap</span>(nex[i],nex[j]);<br>				f[<span class="hljs-built_in">find</span>(i)]=f[<span class="hljs-built_in">find</span>(j)];<br>			&#125;<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0 &quot;</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,j=nex[<span class="hljs-number">0</span>];i&lt;=n;i++,j=nex[j]) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d &quot;</span>,j);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="LZ4416-easy"><a href="#LZ4416-easy" class="headerlink" title="LZ4416 easy"></a>LZ4416 easy</h2><p>集训的题目，神仙 $Qiuly$ 的 $CDQ$ 分治 $+$ 虚树的做法没搞懂，树分块的做法不想学树分块，前两天知道神仙 $HM$ 的树剖维护轻儿子连通块的做法，马上就会了。不过打 $+$ 对拍 $+$ 调了四五个小时（<del>菜狗石锤</del>），然而 $HM$ 想 $+$ 打 $+$ 调只用了 $40$ 分钟，这就是差距 $QWQ$。</p>
<p>我们求出了每个询问的连通块大小之后，用求连续的组合数和就可以了。重点是怎么维护连通块大小。</p>
<p>对于每个节点 $x$ ，我们在线段树上维护他轻儿子连通块的大小 $sum$ 和他连向父亲节点的边的状态 $op$，这两个操作在线段树上二分就好了。</p>
<p>对于询问操作，我们先将 $x$ 跳到与他连通的深度最浅的点$X$，再在 $X$ 所在的重链上找到与他连通的深度最大的点 $Y$ ，答案就是 $[X,Y]$ 这条链上的 $sum +dep[Y]-dep[X]+1$ 。</p>
<p>对于修改操作，设路径为 $[x,y]$，与 $LCA$ 连通的深度最浅的点是 $z$ 。我们先对 $[z,x] \cup [z,y]$ 路径上连通的轻边，从上往下更新轻儿子大小。然后在翻转 $[x,y]$。最后再对$[z,x] \cup [z,y]$ 路径上连通的轻边，从下往上更新轻儿子大小。</p>
<p>全部的锅都处在了修改操作上面，一开始没有考虑修改和更新的顺序，然后又发现没有维护 $[z,LCA]$ 这条路径上的信息 ，主要就是这两个点。</p>
<p>$A$ 了后看了下 $HM$ 的代码，发现自己修改操作那里很傻。其实多那一个数组 $siz$ 记录当前轻子树的大小，每次先减去原来的 $siz$，再重新求一次 $siz$ 加上去就好了。（<del>菜飞力</del>）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cmath&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> fac[N],inv[N],invf[N],gen[N],len;<br><span class="hljs-type">int</span> n,m,q,tot,head[N],nex[N&lt;&lt;<span class="hljs-number">1</span>],v[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> cnt,dep[N],dep_son[N],son[N],siz[N],tag[N],seg[N],top[N],f[N];<br><span class="hljs-type">int</span> ans[N],Ans,A,B;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> rev,sum,op;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Que</span><br>&#123;<br>	<span class="hljs-type">int</span> l,r,id;<br>&#125;que[N];<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(Que a,Que b)</span> </span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(a.l/len==b.l/len)<br>	&#123;<br>		<span class="hljs-type">int</span> bl=a.l/len;<br>		<span class="hljs-keyword">if</span>(bl&amp;<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> a.r&gt;b.r;<br>		<span class="hljs-keyword">return</span> a.r&lt;b.r;<br>	&#125;<br>	<span class="hljs-keyword">return</span>  a.l&lt;b.l;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];v[tot]=y;head[x]=tot;<br>	nex[++tot]=head[y];v[tot]=x;head[y]=tot;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span></span><br><span class="hljs-function"></span>&#123;<br>	f[x]=fa;<br>	dep[x]=dep[fa]<span class="hljs-number">+1</span>;<br>	siz[x]=<span class="hljs-number">1</span>;dep_son[x]=x;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>	&#123;<br>		<span class="hljs-type">int</span> y=v[i];<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs1</span>(y,x);<br>		<span class="hljs-keyword">if</span>(siz[son[x]]&lt;siz[y]) son[x]=y,dep_son[x]=dep_son[y];<br>		siz[x]+=siz[y];<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	seg[x]=++cnt;tag[cnt]=x;<br>	<span class="hljs-keyword">if</span>(son[x]) top[son[x]]=top[x],<span class="hljs-built_in">dfs2</span>(son[x]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>	&#123;<br>		<span class="hljs-type">int</span> y=v[i];<br>		<span class="hljs-keyword">if</span>(top[y]) <span class="hljs-keyword">continue</span>;<br>		top[y]=y;<span class="hljs-built_in">dfs2</span>(y);<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reverse</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].op=r-l<span class="hljs-number">+1</span>-t[k].op;<br>	t[k].rev^=<span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">reverse</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">reverse</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>	t[k].rev^=<span class="hljs-number">1</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].sum=t[k&lt;&lt;<span class="hljs-number">1</span>].sum+t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].sum;<br>	t[k].op=t[k&lt;&lt;<span class="hljs-number">1</span>].op+t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].op;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		t[k].op=(l!=<span class="hljs-number">1</span>);<br>		t[k].sum=siz[tag[l]]-siz[son[tag[l]]]<span class="hljs-number">-1</span>;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">reverse</span>(k,l,r),<span class="hljs-built_in">void</span>();<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y);<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">change</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> t[k].sum+=val,<span class="hljs-built_in">void</span>();<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">change</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,val);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">change</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,val);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">queryl_op</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l&gt;x||t[k].op==r-l<span class="hljs-number">+1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> l;<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> res=<span class="hljs-built_in">queryl_op</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>	<span class="hljs-keyword">if</span>(res) <span class="hljs-keyword">return</span> res;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">queryl_op</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">queryr_op</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(r&lt;x||t[k].op==r-l<span class="hljs-number">+1</span>) <span class="hljs-keyword">return</span> n<span class="hljs-number">+1</span>;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> l;<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> res=<span class="hljs-built_in">queryr_op</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>	<span class="hljs-keyword">if</span>(res!=n<span class="hljs-number">+1</span>) <span class="hljs-keyword">return</span> res;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">queryr_op</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_op</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> t[k].op;<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query_op</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query_op</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> t[k].sum;<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(t[k].rev) <span class="hljs-built_in">pushdown</span>(k,l,r);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y)+<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> type)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x==<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-type">int</span> op=<span class="hljs-built_in">query_op</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x]);<br>	<span class="hljs-keyword">if</span>(!op) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-type">int</span> r=<span class="hljs-built_in">queryr_op</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x]<span class="hljs-number">+1</span>)<span class="hljs-number">-1</span>;<br>	r=<span class="hljs-built_in">min</span>(seg[dep_son[x]],r);<br>	<span class="hljs-type">int</span> g=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x],r)+dep[tag[r]]-dep[x]<span class="hljs-number">+1</span>;<br>	<span class="hljs-built_in">change</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[f[x]],type*g);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_reverse</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> fx=top[x],fy=top[y];<br>	<span class="hljs-type">int</span> st[N],stf[N],nf=<span class="hljs-number">0</span>,num=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(fx!=fy)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(dep[fx]&lt;dep[fy]) <span class="hljs-built_in">swap</span>(fx,fy),<span class="hljs-built_in">swap</span>(x,y);<br>		st[++num]=x;<br>		x=f[fx];fx=top[x];<br>	&#125;<br>	<span class="hljs-keyword">if</span>(dep[x]&gt;dep[y]) <span class="hljs-built_in">swap</span>(x,y);<br>	<span class="hljs-type">int</span> u=x;<br>	<span class="hljs-keyword">while</span>(top[u]!=<span class="hljs-number">1</span>)<br>	&#123;<br>		<span class="hljs-type">int</span> op=<span class="hljs-built_in">query_op</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[top[u]]);<br>		<span class="hljs-keyword">if</span>(!op) <span class="hljs-keyword">break</span>;<br>		stf[++nf]=u;u=f[top[u]];<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=nf;i;i--) <span class="hljs-built_in">update</span>(top[stf[i]],<span class="hljs-number">-1</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=num;i;i--) <span class="hljs-built_in">update</span>(top[st[i]],<span class="hljs-number">-1</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=num;i++) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[top[st[i]]],seg[st[i]]);<br>	<span class="hljs-keyword">if</span>(x!=y) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x]<span class="hljs-number">+1</span>,seg[y]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=num;i++) <span class="hljs-built_in">update</span>(top[st[i]],<span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=nf;i++) <span class="hljs-built_in">update</span>(top[stf[i]],<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Query</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> l=x,r=x;<br>	<span class="hljs-keyword">while</span>(r)<br>	&#123;<br>		l=<span class="hljs-built_in">queryl_op</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[r]);<br>		<span class="hljs-keyword">if</span>(l&lt;seg[top[r]]) r=f[top[r]];<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>	&#125;<br>	x=tag[l];<br>    r=<span class="hljs-built_in">queryr_op</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x]<span class="hljs-number">+1</span>)<span class="hljs-number">-1</span>;<br>	r=<span class="hljs-built_in">min</span>(seg[dep_son[x]],r);<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,seg[x],r)+dep[tag[r]]-dep[x]<span class="hljs-number">+1</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	f[<span class="hljs-number">0</span>]=invf[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=f[<span class="hljs-number">1</span>]=gen[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n;i++)<br>	&#123;<br>		f[i]=<span class="hljs-number">1ll</span>*f[i<span class="hljs-number">-1</span>]*i%mod;<br>		inv[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*inv[mod%i]%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) gen[i]=<span class="hljs-number">2ll</span>*gen[i<span class="hljs-number">-1</span>]%mod,invf[i]=<span class="hljs-number">1ll</span>*inv[i]*invf[i<span class="hljs-number">-1</span>]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;y) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1ll</span>*f[x]*invf[y]%mod*invf[x-y]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> op)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(op) Ans=(Ans+<span class="hljs-built_in">C</span>(A,++B))%mod;<br>	<span class="hljs-keyword">else</span> Ans=(<span class="hljs-number">1ll</span>*Ans*<span class="hljs-number">2</span>%mod-<span class="hljs-built_in">C</span>(A++,B))%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Del</span><span class="hljs-params">(<span class="hljs-type">int</span> op)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(op) Ans=(Ans-<span class="hljs-built_in">C</span>(A,B--))%mod;<br>	<span class="hljs-keyword">else</span> Ans=<span class="hljs-number">1ll</span>*(Ans+<span class="hljs-built_in">C</span>(--A,B))*inv[<span class="hljs-number">2</span>]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> op,x,y;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y),<span class="hljs-built_in">Add</span>(x,y);<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);top[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;op,&amp;x,&amp;y);<br>		<span class="hljs-keyword">if</span>(!op) <span class="hljs-built_in">modify_reverse</span>(x,y);<br>		<span class="hljs-keyword">else</span> x=<span class="hljs-built_in">Query</span>(x),que[++q]=(Que)&#123;x,y<span class="hljs-number">-1</span>,q&#125;;<br>	&#125;<br>	<span class="hljs-built_in">init</span>(); len=<span class="hljs-built_in">sqrt</span>(n);<br>	<span class="hljs-built_in">sort</span>(que<span class="hljs-number">+1</span>,que<span class="hljs-number">+1</span>+q,cmp);<br>	A=B=<span class="hljs-number">0</span>;Ans=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(A&lt;que[i].l) <span class="hljs-built_in">Add</span>(<span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">while</span>(A&gt;que[i].l) <span class="hljs-built_in">Del</span>(<span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">while</span>(B&lt;que[i].r) <span class="hljs-built_in">Add</span>(<span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">while</span>(B&gt;que[i].r) <span class="hljs-built_in">Del</span>(<span class="hljs-number">1</span>);<br>		ans[que[i].id]=gen[que[i].l]-Ans;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,(ans[i]%mod+mod)%mod);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><del>没错，没有任何注释</del></p>
<h2 id="P4443-Dojave"><a href="#P4443-Dojave" class="headerlink" title="P4443 Dojave"></a>P4443 Dojave</h2><p>我真的是太菜力。</p>
<p>对于一个区间异或和为 $S$ ，那其实就是在区间内外分别选两个数 $x$ 和 $y$ ,使得 $x \oplus y$ &#x3D; $S \oplus (2^{m}-1)$</p>
<p>考虑一下怎样才能构造出一个合法的区间。</p>
<p>对于长度为奇数的很明显可以将 $x \oplus y&#x3D; S \oplus (2^m-1)$ 的两两配对，最后肯定剩下一个数没有被匹配，所以一定有解。</p>
<p>对于长度为偶数的情况依旧这样配对，不完全配对一定有解，所以只考虑完全配对。</p>
<p>设 $n&#x3D;2k$</p>
<ul>
<li><p>$k$ 为奇数时，前 $k-1$ 对的异或和为 $0$ ，所以最后一对有 $S&#x3D;x \oplus y&#x3D;S\oplus (2^m-1)$，所以 $x\oplus y&#x3D;0$ 矛盾。</p>
</li>
<li><p>$k$ 为偶数时，$S&#x3D;0$，所以只有存在 $x$ 在这个区间，使得 $x\oplus(2^m-1)$ 不在这个区间中就有解。</p>
</li>
</ul>
<p>最后发现无解的区间只有长度为 $4$ 的倍数且区间内的数 $x\oplus y&#x3D;2^m-1$ 两两配对的情况才无解，所以考虑如何判断一段区间内的数是否两两配对。</p>
<p>这是一个小 $tirck$ ，就是对于配对的两个数赋值为同一个随机数，然后判断区间异或和是否为 $0$ 。</p>
<p>最后还要特判一下 $m&#x3D;1$ 的情况。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdlib&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;ctime&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;map&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br> <br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e6</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,pos[N],vis[N];<br>ll a[N],s[N];<br><span class="hljs-type">int</span> lim,tag;<br>map&lt;ll,<span class="hljs-type">int</span>&gt;mp[<span class="hljs-number">4</span>]; <br>ll ans;<br> <br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-number">0</span>));<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;m);<br>    n=<span class="hljs-number">1</span>&lt;&lt;m;lim=n<span class="hljs-number">-1</span>;<br>    ans=<span class="hljs-number">1ll</span>*(n<span class="hljs-number">+1</span>)*n/<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <br>        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,&amp;a[i]),pos[a[i]]=i;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>    &#123;<br>        <span class="hljs-keyword">if</span>(!vis[i])<br>        &#123;<br>            vis[i]=vis[pos[lim^a[i]]]=<span class="hljs-number">1</span>;<br>            a[i]=a[pos[lim^a[i]]]=<span class="hljs-number">1ll</span>*<span class="hljs-built_in">rand</span>()*<span class="hljs-built_in">rand</span>();<br>        &#125;<br>        s[i]=s[i<span class="hljs-number">-1</span>]^a[i];<br>    &#125;<br>    mp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>    &#123;<br>        ans-=mp[i%<span class="hljs-number">4</span>][s[i]];<br>        mp[i%<span class="hljs-number">4</span>][s[i]]++;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(m!=<span class="hljs-number">1</span>) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,ans);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;2&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <br>&#125; <br></code></pre></td></tr></table></figure>

<h2 id="CF963E-Circles-of-Waiting-loj-3080-国际象棋"><a href="#CF963E-Circles-of-Waiting-loj-3080-国际象棋" class="headerlink" title="CF963E Circles of Waiting &amp;&amp; loj 3080 国际象棋"></a>CF963E Circles of Waiting &amp;&amp; loj 3080 国际象棋</h2><p>两道都是主元法，最近遇到太多次了。</p>
<h2 id="CF963E-Circles-of-Waiting"><a href="#CF963E-Circles-of-Waiting" class="headerlink" title="CF963E Circles of Waiting "></a>CF963E Circles of Waiting </h2><p>设 $f_{i,j}$ 为从 $(i,j)$ 这个点开始走出去的期望步数。</p>
<p>所以容易有 $f_{i,j}&#x3D;\sum\limits_{k&#x3D;1}\limits^{4}p_k\times f_{i+x_k,j+y_k} +1$</p>
<p>当一个点的距离超过 $R$ 时，显然有 $f_{i,j}&#x3D;0$。所以我们将每行第一个 $(i,j)$ 的 $f_{i,j}$ 定为一个主元，然后通过关系式向右递推到 $f_{i,j}&#x3D;0$ 的情况，这样就得到了若干个方程，高斯消元一下就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">111</span>,mod=<span class="hljs-number">1e9</span><span class="hljs-number">+7</span>;<br><span class="hljs-type">int</span> n,R,a0,a1,a2,a3,a4;<br><span class="hljs-type">int</span> b[N][N],can[N*N],ed[N*N];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">qsm</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) res=<span class="hljs-number">1ll</span>*res*a%mod;<br>		a=<span class="hljs-number">1ll</span>*a*a%mod;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">vec</span>&#123;<span class="hljs-type">int</span> x,y;&#125;;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span> <br>&#123; <br>	<span class="hljs-type">int</span> a[N];<br>&#125;f[N*N];<br><br><span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt; (vec p,vec q)&#123;<span class="hljs-keyword">return</span> p.x&gt;q.x;&#125;<br>priority_queue&lt;vec&gt;q;<br>node <span class="hljs-keyword">operator</span> *(<span class="hljs-type">int</span> x,node y) <br>&#123; <br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>;i++) y.a[i]=<span class="hljs-number">1ll</span>*y.a[i]*x%mod;<br>	<span class="hljs-keyword">return</span> y;<br>&#125;<br>node <span class="hljs-keyword">operator</span> +(node x,node y) <br>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>;i++) x.a[i]=(x.a[i]+y.a[i])%mod;<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br>node <span class="hljs-keyword">operator</span> +(node x,<span class="hljs-type">int</span> y)<br>&#123;<br>	x.a[<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]=(x.a[<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]+y)%mod;<br>	<span class="hljs-keyword">return</span> x;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">pos</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span> </span>&#123; <span class="hljs-keyword">return</span> (y+R<span class="hljs-number">+1</span>)*n+(x+R<span class="hljs-number">+2</span>); &#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Calc</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R;i++)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(!b[i][i])<br>		&#123;<br>			<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i<span class="hljs-number">+1</span>;j&lt;=<span class="hljs-number">2</span>*R;j++)<br>				<span class="hljs-keyword">if</span>(b[j][i])&#123;k=j;<span class="hljs-keyword">break</span>;&#125;<br>			<span class="hljs-keyword">if</span>(!k) <span class="hljs-keyword">break</span> ;<br>			<span class="hljs-built_in">swap</span>(b[i],b[k]);<br>		&#125;<br>		<span class="hljs-type">int</span> inv=<span class="hljs-built_in">qsm</span>(b[i][i],mod<span class="hljs-number">-2</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=<span class="hljs-number">2</span>*R;j++)<br>		&#123;<br>			<span class="hljs-keyword">if</span>(i==j) <span class="hljs-keyword">continue</span>;<br>			<span class="hljs-type">int</span> p=<span class="hljs-number">1ll</span>*inv*(mod-b[j][i])%mod;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=i;k&lt;=<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>;k++)<br>				b[j][k]=(b[j][k]<span class="hljs-number">+1ll</span>*p*b[i][k]%mod)%mod;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R;i++) b[i][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]=<span class="hljs-number">1ll</span>*b[i][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]*<span class="hljs-built_in">qsm</span>(b[i][i],mod<span class="hljs-number">-2</span>)%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d%d%d&quot;</span>,&amp;R,&amp;a1,&amp;a2,&amp;a3,&amp;a4);<br>	n=<span class="hljs-number">2</span>*R<span class="hljs-number">+3</span>;a0=<span class="hljs-built_in">qsm</span>(a1+a2+a3+a4,mod<span class="hljs-number">-2</span>);<br>	a1=<span class="hljs-number">1ll</span>*a1*a0%mod;a2=<span class="hljs-number">1ll</span>*a2*a0%mod;a3=<span class="hljs-number">1ll</span>*a3*a0%mod;a4=<span class="hljs-number">1ll</span>*a4*a0%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=-R;i&lt;=R;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=-R;j&lt;=R;j++)<br>			<span class="hljs-keyword">if</span>(i*i+j*j&lt;=R*R) can[<span class="hljs-built_in">pos</span>(i,j)]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=-R;j&lt;=R;j++)<br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=-R;i&lt;=<span class="hljs-number">0</span>;i++) <br>			<span class="hljs-keyword">if</span>(can[<span class="hljs-built_in">pos</span>(i,j)])<br>			&#123;<br>				q.<span class="hljs-built_in">push</span>(vec&#123;i,j&#125;);<br>				f[<span class="hljs-built_in">pos</span>(i,j)].a[j+R]=<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=R;i&gt;=-R;i--) <br>			<span class="hljs-keyword">if</span>(can[<span class="hljs-built_in">pos</span>(i,j)])<br>			&#123;<br>				ed[<span class="hljs-built_in">pos</span>(i,j)]=<span class="hljs-number">1</span>;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>	&#125;<br>	<span class="hljs-keyword">while</span>(!q.<span class="hljs-built_in">empty</span>())<br>	&#123;<br>		<span class="hljs-type">int</span> x=q.<span class="hljs-built_in">top</span>().x,y=q.<span class="hljs-built_in">top</span>().y;q.<span class="hljs-built_in">pop</span>();<br>		f[<span class="hljs-built_in">pos</span>(x<span class="hljs-number">+1</span>,y)]=<span class="hljs-built_in">qsm</span>(a1,mod<span class="hljs-number">-2</span>)*(f[<span class="hljs-built_in">pos</span>(x,y)]+((mod-a2)*f[<span class="hljs-built_in">pos</span>(x,y<span class="hljs-number">+1</span>)])+((mod-a3)*f[<span class="hljs-built_in">pos</span>(x<span class="hljs-number">-1</span>,y)])+((mod-a4)*f[<span class="hljs-built_in">pos</span>(x,y<span class="hljs-number">-1</span>)])+(mod<span class="hljs-number">-1</span>));<br>		<span class="hljs-keyword">if</span>(ed[<span class="hljs-built_in">pos</span>(x,y)])<br>		&#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>;i++) b[y+R][i]=f[<span class="hljs-built_in">pos</span>(x<span class="hljs-number">+1</span>,y)].a[i];<br>			b[y+R][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]=mod-b[y+R][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>];<br>		&#125;<br>		<span class="hljs-keyword">else</span> q.<span class="hljs-built_in">push</span>(vec&#123;x<span class="hljs-number">+1</span>,y&#125;);<br>	&#125;<br>	<span class="hljs-built_in">Calc</span>();<br>	b[<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> Ans=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>;i++) Ans=(Ans<span class="hljs-number">+1ll</span>*f[<span class="hljs-built_in">pos</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)].a[i]*b[i][<span class="hljs-number">2</span>*R<span class="hljs-number">+1</span>]%mod)%mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,Ans);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="loj-3080-「2019-集训队互测-Day-5」国际象棋"><a href="#loj-3080-「2019-集训队互测-Day-5」国际象棋" class="headerlink" title="loj 3080. 「2019 集训队互测 Day 5」国际象棋"></a>loj 3080. 「2019 集训队互测 Day 5」国际象棋</h2><p>这题走日字其实也是一样的，我们只需要把第一二行和第一列的点设为主元转移就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">222</span>,mod=<span class="hljs-number">998244353</span>;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<br>	<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-string">&#x27;0&#x27;</span>||ch&gt;<span class="hljs-string">&#x27;9&#x27;</span>) ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">while</span>(ch&gt;=<span class="hljs-string">&#x27;0&#x27;</span>&amp;&amp;ch&lt;=<span class="hljs-string">&#x27;9&#x27;</span>)<br>		res=(res&lt;&lt;<span class="hljs-number">1</span>)+(res&lt;&lt;<span class="hljs-number">3</span>)+(ch^<span class="hljs-number">48</span>),ch=<span class="hljs-built_in">getchar</span>();<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&gt;=<span class="hljs-number">10</span>) <span class="hljs-built_in">print</span>(x/<span class="hljs-number">10</span>);<br>	<span class="hljs-built_in">putchar</span>((x%<span class="hljs-number">10</span>)^<span class="hljs-number">48</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">qsm</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;b;b&gt;&gt;=<span class="hljs-number">1</span>)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(b&amp;<span class="hljs-number">1</span>) res=<span class="hljs-number">1ll</span>*res*a%mod;<br>		a=<span class="hljs-number">1ll</span>*a*a%mod;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-type">int</span> n,m,cnt,tot,p[<span class="hljs-number">10</span>],mat[N*N][N*<span class="hljs-number">3</span>],b[N*<span class="hljs-number">3</span>][N*<span class="hljs-number">3</span>];<br><span class="hljs-type">int</span> xx[<span class="hljs-number">10</span>]=&#123;<span class="hljs-number">0</span>,<span class="hljs-number">-2</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-2</span>&#125;;<br><span class="hljs-type">int</span> yy[<span class="hljs-number">10</span>]=&#123;<span class="hljs-number">0</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-2</span>,<span class="hljs-number">-2</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">pos</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<span class="hljs-keyword">return</span> (x<span class="hljs-number">-1</span>)*(m<span class="hljs-number">+1</span>)+y;&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	x+=y;<br>	<span class="hljs-keyword">if</span>(x&gt;=mod) x-=mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">calc</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;cnt;i++)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(!b[i][i])<br>		&#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i<span class="hljs-number">+1</span>;j&lt;cnt;j++)<br>				<span class="hljs-keyword">if</span>(b[j][i]) &#123; <span class="hljs-built_in">swap</span>(b[i],b[j]);<span class="hljs-keyword">break</span>;&#125;<br>			<span class="hljs-keyword">if</span>(!b[i][i]) <span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-type">int</span> inv=<span class="hljs-built_in">qsm</span>(b[i][i],mod<span class="hljs-number">-2</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=cnt;k++) b[i][k]=<span class="hljs-number">1ll</span>*b[i][k]*inv%mod;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;cnt;j++)<br>		&#123;<br>			<span class="hljs-keyword">if</span>(i==j) <span class="hljs-keyword">continue</span>;<br>			<span class="hljs-type">int</span> p=mod-b[j][i]%mod;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=i;k&lt;=cnt;k++) <span class="hljs-built_in">Add</span>(b[j][k],<span class="hljs-number">1ll</span>*p*b[i][k]%mod);<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	n=<span class="hljs-built_in">read</span>();m=<span class="hljs-built_in">read</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">8</span>;i++) p[i]=<span class="hljs-built_in">read</span>(),p[<span class="hljs-number">0</span>]+=p[i];<br>	p[<span class="hljs-number">0</span>]=<span class="hljs-built_in">qsm</span>(p[<span class="hljs-number">0</span>],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">8</span>;i++) p[i]=<span class="hljs-number">1ll</span>*p[i]*p[<span class="hljs-number">0</span>]%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">2</span>;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++) mat[<span class="hljs-built_in">pos</span>(i,j)][++cnt]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">3</span>;i&lt;=n;i++) mat[<span class="hljs-built_in">pos</span>(i,<span class="hljs-number">1</span>)][++cnt]=<span class="hljs-number">1</span>;<br>	cnt++;<br>	<span class="hljs-type">int</span> inv=<span class="hljs-built_in">qsm</span>(p[<span class="hljs-number">5</span>],mod<span class="hljs-number">-2</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++)<br>		&#123;<br>			<span class="hljs-type">int</span> x=i<span class="hljs-number">+2</span>,y=j<span class="hljs-number">+1</span>; <br>			<span class="hljs-type">int</span> u=<span class="hljs-built_in">pos</span>(x,y);<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=cnt;k++) mat[u][k]=mat[<span class="hljs-built_in">pos</span>(i,j)][k];<br>			mat[u][cnt]=mat[u][cnt]<span class="hljs-number">+1</span>;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=<span class="hljs-number">8</span>;k++)<br>			&#123;<br>				<span class="hljs-keyword">if</span>(k==<span class="hljs-number">5</span>||i+xx[k]&lt;<span class="hljs-number">1</span>||i+xx[k]&gt;n||j+yy[k]&lt;<span class="hljs-number">1</span>||j+yy[k]&gt;m) <span class="hljs-keyword">continue</span>;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l=<span class="hljs-number">1</span>;l&lt;=cnt;l++)<br>					<span class="hljs-built_in">Add</span>(mat[u][l],<span class="hljs-number">1ll</span>*(mod-p[k])*mat[<span class="hljs-built_in">pos</span>(i+xx[k],j+yy[k])][l]%mod);<br>			&#125;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=cnt;k++) mat[u][k]=<span class="hljs-number">1ll</span>*mat[u][k]*inv%mod;<br>			<span class="hljs-keyword">if</span>(x&gt;n||y&gt;m)<br>			&#123;<br>				tot++;<br>				<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">1</span>;k&lt;=cnt;k++) b[tot][k]=mat[u][k];<br>			&#125;<br>		&#125;<br>	<span class="hljs-built_in">calc</span>();<br>	<span class="hljs-type">int</span> T,x,y,ans;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;T);<br>	<span class="hljs-keyword">while</span>(T--)<br>	&#123;<br>		x=<span class="hljs-built_in">read</span>();y=<span class="hljs-built_in">read</span>();<br>		ans=mod-mat[<span class="hljs-built_in">pos</span>(x,y)][cnt];<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;cnt;i++) <span class="hljs-built_in">Add</span>(ans,<span class="hljs-number">1ll</span>*mat[<span class="hljs-built_in">pos</span>(x,y)][i]*b[i][cnt]%mod);<br>		<span class="hljs-built_in">print</span>(ans);<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="decoration"><a href="#decoration" class="headerlink" title="decoration"></a>decoration</h2><h2 id="题面"><a href="#题面" class="headerlink" title="题面"></a>题面</h2><blockquote>
<p>  有一个 $2\times m$ 的矩阵，要求将每个格子染成 红&#x2F;绿&#x2F;蓝 色，且满足：</p>
</blockquote>
<blockquote>
<p>  有 $R$ 个红色格，$G$ 个绿色格，$B$ 个蓝色格。</p>
</blockquote>
<blockquote>
<p>  相邻格子的颜色不相同。</p>
</blockquote>
<blockquote>
<p>  每个 $2 \times 2$ 矩阵中含有三种颜色。</p>
</blockquote>
<blockquote>
<p>  $1≤m≤10^6,R+G+B&#x3D;2m$</p>
</blockquote>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>数数题，模拟赛的时候数出来了，感觉难度适中。</p>
<p>考虑每列其实只有三种情况 $[R,G] \ [G,B] \ [R,B]$，而且这三中情况的具体个数是一定的，确定了前一列就可以确定当前列是正着还是反着放。所以问题转化成有若干个三种颜色的小球排序，相邻两个颜色不同的方案数。</p>
<p>我们先令 $[R,G] \ [G,B] \ [R,B]$ 三种小球个数为 $a,b,c$ 。</p>
<p>我们假设在放完两种球之后，还有 $i$ 对相邻小球颜色相同。那么方案数为 ${a-b+1-i \choose c-i}$。所以我们现在只需要求出两种小球放完后有 $i$ 对相邻小球颜色相同的方案数。把过程看成把一种小球放入到另一种小球，然后我们就分情况讨论一下。</p>
<ul>
<li><p>没有小球放在两边的情况，设插入 $k$ 个空，形成了 $i$ 对相邻小球颜色相同 ，那么就可以推出 $k&#x3D;\frac{a+b-i-1}{2}$，方案数为 ${a-1 \choose k}{b-1 \choose k-1}$</p>
</li>
<li><p>有小球放在前边或后边的情况,同理推出 $k&#x3D;\frac{a+b-i}{2}$ ，方案数为 ${a-1\choose k-1}{b-1\choose k-1}$</p>
</li>
<li><p>有小球放在两边的情况, $k&#x3D;\frac{a+b-i+1}{2}$ ，方案数为 ${a-1\choose k-2}{b-1 \choose k-1}$</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e6</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">1e9</span><span class="hljs-number">+7</span>;<br><span class="hljs-type">int</span> n,R,G,B,a,b,c,s[<span class="hljs-number">4</span>];<br><span class="hljs-type">int</span> fac[N],inv[N],f[N],ans;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n<span class="hljs-number">+1</span>;i++)<br>	&#123;<br>		fac[i]=<span class="hljs-number">1ll</span>*fac[i<span class="hljs-number">-1</span>]*i%mod;<br>		inv[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*inv[mod%i]%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n<span class="hljs-number">+1</span>;i++) inv[i]=<span class="hljs-number">1ll</span>*inv[i]*inv[i<span class="hljs-number">-1</span>]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;y) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;<span class="hljs-number">0</span>||y&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1ll</span>*fac[x]*inv[y]%mod*inv[x-y]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d%d&quot;</span>,&amp;n,&amp;R,&amp;G,&amp;B);<br>	s[<span class="hljs-number">1</span>]=(G+R-B)/<span class="hljs-number">2</span>;s[<span class="hljs-number">2</span>]=(R+B-G)/<span class="hljs-number">2</span>;s[<span class="hljs-number">3</span>]=(G+B-R)/<span class="hljs-number">2</span>;<br>	<span class="hljs-built_in">sort</span>(s<span class="hljs-number">+1</span>,s<span class="hljs-number">+3</span>);<br>	a=s[<span class="hljs-number">3</span>];b=s[<span class="hljs-number">2</span>];c=s[<span class="hljs-number">1</span>];<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-keyword">if</span>(!b)<br>	&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,a==<span class="hljs-number">1</span>? <span class="hljs-number">2</span>:<span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;a+b;i++)<br>	&#123;<br>		<span class="hljs-type">int</span> k=a+b-i<span class="hljs-number">-1</span>;<br>		<span class="hljs-keyword">if</span>(k%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>)<br>		&#123;<br>			k/=<span class="hljs-number">2</span>;<br>			f[i]=(f[i]<span class="hljs-number">+1ll</span>*<span class="hljs-built_in">C</span>(a<span class="hljs-number">-1</span>,k)*<span class="hljs-built_in">C</span>(b<span class="hljs-number">-1</span>,k<span class="hljs-number">-1</span>)%mod)%mod;<br>			k++;<br>			f[i]=(f[i]<span class="hljs-number">+1ll</span>*<span class="hljs-built_in">C</span>(a<span class="hljs-number">-1</span>,k<span class="hljs-number">-2</span>)*<span class="hljs-built_in">C</span>(b<span class="hljs-number">-1</span>,k<span class="hljs-number">-1</span>)%mod)%mod;<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			k++;k/=<span class="hljs-number">2</span>;<br>			f[i]=(f[i]<span class="hljs-number">+2ll</span>*<span class="hljs-built_in">C</span>(a<span class="hljs-number">-1</span>,k<span class="hljs-number">-1</span>)*<span class="hljs-built_in">C</span>(b<span class="hljs-number">-1</span>,k<span class="hljs-number">-1</span>)) %mod;<br>		&#125;<br>		ans=(ans<span class="hljs-number">+1ll</span>*f[i]*<span class="hljs-built_in">C</span>(a+b<span class="hljs-number">+1</span>-i,c-i)%mod)%mod;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,<span class="hljs-number">2ll</span>*ans%mod);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<h2 id="Loj2743-「JOI-Open-2016」摩天大楼"><a href="#Loj2743-「JOI-Open-2016」摩天大楼" class="headerlink" title="Loj2743. 「JOI Open 2016」摩天大楼"></a>Loj2743. 「JOI Open 2016」摩天大楼</h2><h2 id="题面-1"><a href="#题面-1" class="headerlink" title="题面"></a>题面</h2><blockquote>
<p>将互不相同的 N 个整数 $A_1, A_2, \dots, A_N$ 按照一定顺序排列。</p>
</blockquote>
<blockquote>
<p>假设排列为 $f_1, f_2, \dots, f_N$，要求：$|f_2-f_1|+|f_3-f_2|+\dots+|f_N-f_{N-1}| \le L$。</p>
</blockquote>
<blockquote>
<p>求满足题意的排列的方案数 $\bmod (10^9+7)$。</p>
</blockquote>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>考虑从小往大加数，每次产生的贡献 $A_i-A_j$ 比较难搞。但我们发现 $A_i-A_j&#x3D;\sum\limits_{k&#x3D;j}\limits^{i-1}A_{k+1}-A_k$，所以每次加入一个数产生的新的贡献为 $(A_{i+1}-A_{i})\times$ 可以产生贡献的位置个数。</p>
<p>设 $dp[i][j][k][l]$ 表示前 $i$ 个数分成 $j$ 段贡献为 $k$ 且有 $l$ 个左右边界已经确定。</p>
<p>所以新的贡献 $k’&#x3D;k+(A_{i+1}-A_i)\times (2j-l)$。接着就分类讨论一下</p>
<ul>
<li><p>合并两段 $dp[i+1][j-1][k’][l]+&#x3D;dp[i][j][k][l]\times (j-1)$</p>
</li>
<li><p>插入一段的两边 $dp[i+1][j][k’][l]+&#x3D;dp[i][j][k][l]\times (2j-l)$</p>
</li>
<li><p>将一段变为边界 $dp[i+1][j][k’][l]+&#x3D;dp[i][j][k][l]\times (2-l)$</p>
</li>
<li><p>成为新的不是边界的一段 $dp[i+1][j+1][k’][l]+&#x3D;dp[i][j][k][l]\times (j+1-l)$</p>
</li>
<li><p>成为新的是边界的一段 $dp[i+1][j+1][k’][l+1]+&#x3D;dp[i][j][k][l]\times(2-l)$</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">105</span>,M=<span class="hljs-number">1005</span>,mod=<span class="hljs-number">1e9</span><span class="hljs-number">+7</span>;<br><span class="hljs-type">int</span> n,L,a[N];<br><span class="hljs-type">int</span> dp[N][N][M][<span class="hljs-number">3</span>],ans;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;x,<span class="hljs-type">int</span> y)</span> </span>&#123; <span class="hljs-keyword">if</span>((x+=y)&gt;=mod) x-=mod; &#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;L);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-keyword">if</span>(n==<span class="hljs-number">1</span>) <br>	&#123;<br>		<span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(a<span class="hljs-number">+1</span>,a<span class="hljs-number">+1</span>+n);<br>	dp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=i;j++)<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;=L;k++)<br>				<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> l=<span class="hljs-number">0</span>;l&lt;=<span class="hljs-number">2</span>;l++)<br>				&#123;<br>					<span class="hljs-keyword">if</span>(!dp[i][j][k][l]) <span class="hljs-keyword">continue</span>;<br>					<span class="hljs-type">int</span> kk=k+(a[i<span class="hljs-number">+1</span>]-a[i])*(<span class="hljs-number">2</span>*j-l);<br>					<span class="hljs-keyword">if</span>(kk&gt;L) <span class="hljs-keyword">continue</span>;<br>					<span class="hljs-built_in">Add</span>(dp[i<span class="hljs-number">+1</span>][j<span class="hljs-number">+1</span>][kk][l],<span class="hljs-number">1ll</span>*dp[i][j][k][l]*(j<span class="hljs-number">+1</span>-l)%mod);<br>					<span class="hljs-keyword">if</span>(l&lt;<span class="hljs-number">2</span>) <span class="hljs-built_in">Add</span>(dp[i<span class="hljs-number">+1</span>][j<span class="hljs-number">+1</span>][kk][l<span class="hljs-number">+1</span>],<span class="hljs-number">1ll</span>*dp[i][j][k][l]*(<span class="hljs-number">2</span>-l)%mod);<br>					<span class="hljs-built_in">Add</span>(dp[i<span class="hljs-number">+1</span>][j][kk][l],<span class="hljs-number">1ll</span>*dp[i][j][k][l]*(<span class="hljs-number">2</span>*j-l)%mod);<br>					<span class="hljs-keyword">if</span>(j) <span class="hljs-built_in">Add</span>(dp[i<span class="hljs-number">+1</span>][j<span class="hljs-number">-1</span>][kk][l],<span class="hljs-number">1ll</span>*dp[i][j][k][l]*(j<span class="hljs-number">-1</span>)%mod);<br>					<span class="hljs-keyword">if</span>(l&lt;<span class="hljs-number">2</span>&amp;&amp;j) <span class="hljs-built_in">Add</span>(dp[i<span class="hljs-number">+1</span>][j][kk][l<span class="hljs-number">+1</span>],<span class="hljs-number">1ll</span>*dp[i][j][k][l]*(<span class="hljs-number">2</span>-l)%mod);<br>				&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=L;i++) <span class="hljs-built_in">Add</span>(ans,dp[n][<span class="hljs-number">1</span>][i][<span class="hljs-number">2</span>]);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,ans);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1738G-Illumination"><a href="#CF1738G-Illumination" class="headerlink" title="CF1738G Illumination"></a>CF1738G Illumination</h2><p>正着求比较困难 <del>(实则我不会)</del> ，考虑不合法的方案数。</p>
<p>先不考虑询问。 $m$ 很小，所以可以考虑容斥 $f_T$ 表示钦定不被覆盖的集合为 $T$ 的方案数。<br>所以答案是 $(d+1)^{n+1}-\sum\limits_{T \subseteq S}(-1)^{|T|}f_T$ 。 直接做是 $O(n2^m)$  。</p>
<p>但我们发现一个照明灯的范围只和他左右两边的第一个关键点有关，所以我们可以二分一个关键点的覆盖范围和预处理前缀区间到这个关键点的距离之积，这样就可以 $O(2^m \log n)$ 求出答案。</p>
<p>考虑插入一个新的照明灯，那其实我们只需要枚举和他最近的关键点，然后会发现这个东西是枚举端点，端点之间的状态都是 $0$ ,端点的状态是 $1$ ,端点以外的状态随便，明显可 $O(m^22^m)$ 预处理出来。</p>
<p>所以最后复杂度就是 $O(2^m logn+m^22^m+qm)$ 。</p>
<p>调了好久。。。以后果然要把思路完全搞清晰再打代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n,m,d,q,L[N],p[N],R[N];<br><span class="hljs-type">int</span> sum[<span class="hljs-number">20</span>][N],inv[N&lt;&lt;<span class="hljs-number">1</span>],sumv[<span class="hljs-number">20</span>][N],f[N],g[<span class="hljs-number">20</span>][<span class="hljs-number">20</span>],c[<span class="hljs-number">20</span>][<span class="hljs-number">20</span>],ans;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">abs</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">return</span> x&lt;<span class="hljs-number">0</span>? -x:x;&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">range</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> mid,res=l<span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">while</span>(l&lt;=r)<br>	&#123;<br>		<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">abs</span>(p[x]-L[mid])&lt;=<span class="hljs-built_in">abs</span>(p[y]-L[mid])) res=mid,l=mid<span class="hljs-number">+1</span>;<br>		<span class="hljs-keyword">else</span> r=mid<span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123; <br>	inv[<span class="hljs-number">1</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=d;i++)<br>    inv[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*inv[mod%i]%mod;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>    &#123;<br>		 R[i]=<span class="hljs-built_in">upper_bound</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n,p[i])-L<span class="hljs-number">-1</span>;<br>         sum[i][<span class="hljs-number">0</span>]=sumv[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>         <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;j++)<br>         &#123;<br>             sum[i][j]=<span class="hljs-number">1ll</span>*sum[i][j<span class="hljs-number">-1</span>]*<span class="hljs-built_in">abs</span>(L[j]-p[i])%mod;<br>			 sumv[i][j]=<span class="hljs-number">1ll</span>*sumv[i][j<span class="hljs-number">-1</span>]*inv[<span class="hljs-built_in">abs</span>(L[j]-p[i])]%mod;<br>		 &#125;<br>     &#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>	&#123;<br>		R[i]=<span class="hljs-built_in">upper_bound</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n,p[i])-L<span class="hljs-number">-1</span>;<br>		sum[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;j++) <br>			sum[i][j]=<span class="hljs-number">1ll</span>*sum[i][j<span class="hljs-number">-1</span>]*<span class="hljs-built_in">abs</span>(L[j]-p[i])%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;(<span class="hljs-number">1</span>&lt;&lt;m);i++)<br>	&#123;<br>		<span class="hljs-type">int</span> lst=<span class="hljs-number">0</span>,cnt=<span class="hljs-number">0</span>,pos;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++)<br>			<span class="hljs-keyword">if</span>((i&gt;&gt;(j<span class="hljs-number">-1</span>))&amp;<span class="hljs-number">1</span>) <br>			&#123;<br>				cnt++;<br>				<span class="hljs-keyword">if</span>(lst)<br>				&#123;<br>					<span class="hljs-keyword">if</span>(R[lst]!=R[j]) <br>					&#123;<br>				    	pos=<span class="hljs-built_in">range</span>(R[lst]<span class="hljs-number">+1</span>,R[j],lst,j);<br>			     		f[i]=<span class="hljs-number">1ll</span>*f[i]*(<span class="hljs-number">1ll</span>*sum[lst][pos]*sumv[lst][R[lst]]%mod)%mod*(<span class="hljs-number">1ll</span>*sum[j][R[j]]*sumv[j][pos]%mod)%mod;<br>					&#125;<br>				&#125;<br>				<span class="hljs-keyword">else</span> f[i]=sum[j][R[j]];<br>				lst=j;<br>			&#125;<br>		<span class="hljs-keyword">if</span>(R[lst]&lt;n) f[i]=<span class="hljs-number">1ll</span>*f[i]*sum[lst][n]%mod*sumv[lst][R[lst]]%mod;<br>		f[i]=(f[i]+mod)%mod;<br>		<span class="hljs-keyword">if</span>(!(cnt&amp;<span class="hljs-number">1</span>)) f[i]=(mod-f[i]);<br>		lst=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++)<br>			<span class="hljs-keyword">if</span>((i&gt;&gt;(j<span class="hljs-number">-1</span>))&amp;<span class="hljs-number">1</span>)<br>			&#123;<br>				g[lst][j]=(g[lst][j]+f[i])%mod;<br>				lst=j;<br>			&#125;<br>		g[lst][m<span class="hljs-number">+1</span>]=(g[lst][m<span class="hljs-number">+1</span>]+f[i])%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i<span class="hljs-number">+1</span>;j&lt;=m<span class="hljs-number">+1</span>;j++) <br>			c[i][j]=(c[i][j<span class="hljs-number">-1</span>]+g[i][j])%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;i;j++) <br>			g[j][i]=(g[j<span class="hljs-number">-1</span>][i]+g[j][i])%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> l=<span class="hljs-built_in">upper_bound</span>(p<span class="hljs-number">+1</span>,p<span class="hljs-number">+1</span>+m,k)-p<span class="hljs-number">-1</span>,r=l<span class="hljs-number">+1</span>;<br>	<span class="hljs-type">int</span> res=ans,tot=<span class="hljs-number">0</span>,j=r;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=l;i;i--) <br>	&#123;<br>		<span class="hljs-keyword">while</span>(j&lt;=m&amp;&amp;k-p[i]&gt;=p[j]-k) j++;<br>		tot=(tot<span class="hljs-number">+1ll</span>*(k-p[i])*(c[i][m<span class="hljs-number">+1</span>]-c[i][j<span class="hljs-number">-1</span>])%mod)%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=r;i&lt;=m;i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(l&amp;&amp;k-p[l]&lt;p[i]-k) l--;<br>		tot=(tot<span class="hljs-number">+1ll</span>*(p[i]-k)*g[l][i]%mod)%mod;<br>	&#125;<br>	res=(res-tot)%mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,(res+mod)%mod);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;d,&amp;n,&amp;m);<br>	ans=d<span class="hljs-number">+1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;L[i]),ans=<span class="hljs-number">1ll</span>*ans*(d<span class="hljs-number">+1</span>)%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;p[i]);<br>	<span class="hljs-built_in">sort</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n);<span class="hljs-built_in">sort</span>(p<span class="hljs-number">+1</span>,p<span class="hljs-number">+1</span>+m);<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">while</span>(q--)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x),<span class="hljs-built_in">solve</span>(x);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1738G-Illumination-1"><a href="#CF1738G-Illumination-1" class="headerlink" title="CF1738G Illumination"></a>CF1738G Illumination</h2><p>正着求比较困难 <del>(实则我不会)</del> ，考虑不合法的方案数。</p>
<p>先不考虑询问。 $m$ 很小，所以可以考虑容斥 $f_T$ 表示钦定不被覆盖的集合为 $T$ 的方案数。<br>所以答案是 $(d+1)^{n+1}-\sum\limits_{T \subseteq S}(-1)^{|T|}f_T$ 。 直接做是 $O(n2^m)$  。</p>
<p>但我们发现一个照明灯的范围只和他左右两边的第一个关键点有关，所以我们可以二分一个关键点的覆盖范围和预处理前缀区间到这个关键点的距离之积，这样就可以 $O(2^m \log n)$ 求出答案。</p>
<p>考虑插入一个新的照明灯，那其实我们只需要枚举和他最近的关键点，然后会发现这个东西是枚举端点，端点之间的状态都是 $0$ ,端点的状态是 $1$ ,端点以外的状态随便，明显可 $O(m^22^m)$ 预处理出来。</p>
<p>所以最后复杂度就是 $O(2^m logn+m^22^m+qm)$ 。</p>
<p>调了好久。。。以后果然要把思路完全搞清晰再打代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n,m,d,q,L[N],p[N],R[N];<br><span class="hljs-type">int</span> sum[<span class="hljs-number">20</span>][N],inv[N&lt;&lt;<span class="hljs-number">1</span>],sumv[<span class="hljs-number">20</span>][N],f[N],g[<span class="hljs-number">20</span>][<span class="hljs-number">20</span>],c[<span class="hljs-number">20</span>][<span class="hljs-number">20</span>],ans;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">abs</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">return</span> x&lt;<span class="hljs-number">0</span>? -x:x;&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">range</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> mid,res=l<span class="hljs-number">-1</span>;<br>	<span class="hljs-keyword">while</span>(l&lt;=r)<br>	&#123;<br>		<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">abs</span>(p[x]-L[mid])&lt;=<span class="hljs-built_in">abs</span>(p[y]-L[mid])) res=mid,l=mid<span class="hljs-number">+1</span>;<br>		<span class="hljs-keyword">else</span> r=mid<span class="hljs-number">-1</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123; <br>	inv[<span class="hljs-number">1</span>]=inv[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=d;i++)<br>    inv[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*inv[mod%i]%mod;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>    &#123;<br>		 R[i]=<span class="hljs-built_in">upper_bound</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n,p[i])-L<span class="hljs-number">-1</span>;<br>         sum[i][<span class="hljs-number">0</span>]=sumv[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>         <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;j++)<br>         &#123;<br>             sum[i][j]=<span class="hljs-number">1ll</span>*sum[i][j<span class="hljs-number">-1</span>]*<span class="hljs-built_in">abs</span>(L[j]-p[i])%mod;<br>			 sumv[i][j]=<span class="hljs-number">1ll</span>*sumv[i][j<span class="hljs-number">-1</span>]*inv[<span class="hljs-built_in">abs</span>(L[j]-p[i])]%mod;<br>		 &#125;<br>     &#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>	&#123;<br>		R[i]=<span class="hljs-built_in">upper_bound</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n,p[i])-L<span class="hljs-number">-1</span>;<br>		sum[i][<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=n;j++) <br>			sum[i][j]=<span class="hljs-number">1ll</span>*sum[i][j<span class="hljs-number">-1</span>]*<span class="hljs-built_in">abs</span>(L[j]-p[i])%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;(<span class="hljs-number">1</span>&lt;&lt;m);i++)<br>	&#123;<br>		<span class="hljs-type">int</span> lst=<span class="hljs-number">0</span>,cnt=<span class="hljs-number">0</span>,pos;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++)<br>			<span class="hljs-keyword">if</span>((i&gt;&gt;(j<span class="hljs-number">-1</span>))&amp;<span class="hljs-number">1</span>) <br>			&#123;<br>				cnt++;<br>				<span class="hljs-keyword">if</span>(lst)<br>				&#123;<br>					<span class="hljs-keyword">if</span>(R[lst]!=R[j]) <br>					&#123;<br>				    	pos=<span class="hljs-built_in">range</span>(R[lst]<span class="hljs-number">+1</span>,R[j],lst,j);<br>			     		f[i]=<span class="hljs-number">1ll</span>*f[i]*(<span class="hljs-number">1ll</span>*sum[lst][pos]*sumv[lst][R[lst]]%mod)%mod*(<span class="hljs-number">1ll</span>*sum[j][R[j]]*sumv[j][pos]%mod)%mod;<br>					&#125;<br>				&#125;<br>				<span class="hljs-keyword">else</span> f[i]=sum[j][R[j]];<br>				lst=j;<br>			&#125;<br>		<span class="hljs-keyword">if</span>(R[lst]&lt;n) f[i]=<span class="hljs-number">1ll</span>*f[i]*sum[lst][n]%mod*sumv[lst][R[lst]]%mod;<br>		f[i]=(f[i]+mod)%mod;<br>		<span class="hljs-keyword">if</span>(!(cnt&amp;<span class="hljs-number">1</span>)) f[i]=(mod-f[i]);<br>		lst=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=m;j++)<br>			<span class="hljs-keyword">if</span>((i&gt;&gt;(j<span class="hljs-number">-1</span>))&amp;<span class="hljs-number">1</span>)<br>			&#123;<br>				g[lst][j]=(g[lst][j]+f[i])%mod;<br>				lst=j;<br>			&#125;<br>		g[lst][m<span class="hljs-number">+1</span>]=(g[lst][m<span class="hljs-number">+1</span>]+f[i])%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i<span class="hljs-number">+1</span>;j&lt;=m<span class="hljs-number">+1</span>;j++) <br>			c[i][j]=(c[i][j<span class="hljs-number">-1</span>]+g[i][j])%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;i;j++) <br>			g[j][i]=(g[j<span class="hljs-number">-1</span>][i]+g[j][i])%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> l=<span class="hljs-built_in">upper_bound</span>(p<span class="hljs-number">+1</span>,p<span class="hljs-number">+1</span>+m,k)-p<span class="hljs-number">-1</span>,r=l<span class="hljs-number">+1</span>;<br>	<span class="hljs-type">int</span> res=ans,tot=<span class="hljs-number">0</span>,j=r;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=l;i;i--) <br>	&#123;<br>		<span class="hljs-keyword">while</span>(j&lt;=m&amp;&amp;k-p[i]&gt;=p[j]-k) j++;<br>		tot=(tot<span class="hljs-number">+1ll</span>*(k-p[i])*(c[i][m<span class="hljs-number">+1</span>]-c[i][j<span class="hljs-number">-1</span>])%mod)%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=r;i&lt;=m;i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(l&amp;&amp;k-p[l]&lt;p[i]-k) l--;<br>		tot=(tot<span class="hljs-number">+1ll</span>*(p[i]-k)*g[l][i]%mod)%mod;<br>	&#125;<br>	res=(res-tot)%mod;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,(res+mod)%mod);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;d,&amp;n,&amp;m);<br>	ans=d<span class="hljs-number">+1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;L[i]),ans=<span class="hljs-number">1ll</span>*ans*(d<span class="hljs-number">+1</span>)%mod;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;p[i]);<br>	<span class="hljs-built_in">sort</span>(L<span class="hljs-number">+1</span>,L<span class="hljs-number">+1</span>+n);<span class="hljs-built_in">sort</span>(p<span class="hljs-number">+1</span>,p<span class="hljs-number">+1</span>+m);<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">while</span>(q--)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x),<span class="hljs-built_in">solve</span>(x);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;	<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="P4383-林克卡特树"><a href="#P4383-林克卡特树" class="headerlink" title="P4383 林克卡特树"></a>P4383 林克卡特树</h2><p>如果不考虑 $k$ ，任意选的话非常好求。设$dp_{u,0&#x2F;1&#x2F;2}$，其中 $dp_{u,0}$ 表示以 $u$ 为根的子树中的最长链，$dp_{u,1}$ 表示以 $u$ 为端点的最长连， $dp_{u,2}$ 经过 $u$ 的最长链。</p>
<p>$dp_{u,0}&#x3D;dp_{u,0}+dp_{v,0}$</p>
<p>$dp_{u,1}&#x3D;\max{dp_{u,0}+dp_{v,1}+w,dp_{u,1}+dp_{v,0}}$</p>
<p>$dp_{u,2}&#x3D;\max{dp_{u,1}+dp_{v,1}+w,dp_{u,2}+dp_{v,0}}$</p>
<p>$dp_{u,0}&#x3D;\max{dp_{u,0},dp_{u,1},dp_{u,2}}$</p>
<p>最后的答案就是$dp_{1,0}$ 。</p>
<p>这玩意看上去是上凸的 <del>(自己证一下，我不会)</del> ，那么就可以 $wqs$ 二分一下，找到选 $m$ 条边的答案。设当前的斜率为 $mid$ 。</p>
<p>初始 $dp_{u,0&#x2F;1}&#x3D;0 $ ， $dp_{u,2}&#x3D;-mid$</p>
<p>$dp_{u,0}&#x3D;dp_{u,0}+dp_{v,0}$</p>
<p>$dp_{u,1}&#x3D;\max{dp_{u,0}+dp_{v,1}+w,dp_{u,1}+dp_{v,0}}$</p>
<p>$dp_{u,2}&#x3D;\max{dp_{u,1}+dp_{v,1}+w-mid,dp_{u,2}+dp_{v,0}}$</p>
<p>$dp_{u,0}&#x3D;\max{dp_{u,0},dp_{u,1}-mid,dp_{u,2}}$</p>
<p>因为我们是钦定把 $u$ 这个子树分离出来的，所以初始 $m++$ 。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,tot,head[N],nex[N&lt;&lt;<span class="hljs-number">1</span>],v[N&lt;&lt;<span class="hljs-number">1</span>],w[N&lt;&lt;<span class="hljs-number">1</span>];<br>ll l,r,mid,ans;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	ll x;<span class="hljs-type">int</span> y;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt;(<span class="hljs-type">const</span> node &amp;o)<span class="hljs-type">const</span> &#123; <span class="hljs-keyword">return</span> x==o.x? y&lt;o.y:x&lt;o.x;&#125;<br>	node <span class="hljs-keyword">operator</span> +(<span class="hljs-type">const</span> node &amp;o)<span class="hljs-type">const</span> &#123; <span class="hljs-keyword">return</span> (node)&#123;x+o.x,y+o.y&#125;;&#125;<br>&#125;dp[N][<span class="hljs-number">3</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];head[x]=tot;v[tot]=y;w[tot]=z;<br>	nex[++tot]=head[y];head[y]=tot;v[tot]=x;w[tot]=z;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span></span><br><span class="hljs-function"></span>&#123;<br>	dp[x][<span class="hljs-number">0</span>]=dp[x][<span class="hljs-number">1</span>]=(node)&#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>&#125;;<br>	dp[x][<span class="hljs-number">2</span>]=(node)&#123;-mid,<span class="hljs-number">1</span>&#125;;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>	&#123;<br>		<span class="hljs-type">int</span> y=v[i];<br>		<span class="hljs-keyword">if</span>(y==fa) <span class="hljs-keyword">continue</span>;<br>		<span class="hljs-built_in">dfs</span>(y,x);<br>		dp[x][<span class="hljs-number">2</span>]=<span class="hljs-built_in">max</span>(dp[x][<span class="hljs-number">2</span>]+dp[y][<span class="hljs-number">0</span>],dp[x][<span class="hljs-number">1</span>]+dp[y][<span class="hljs-number">1</span>]+(node)&#123;w[i]-mid,<span class="hljs-number">1</span>&#125;);<br>		dp[x][<span class="hljs-number">1</span>]=<span class="hljs-built_in">max</span>(dp[x][<span class="hljs-number">1</span>]+dp[y][<span class="hljs-number">0</span>],dp[x][<span class="hljs-number">0</span>]+dp[y][<span class="hljs-number">1</span>]+(node)&#123;w[i],<span class="hljs-number">0</span>&#125;);<br>		dp[x][<span class="hljs-number">0</span>]=dp[x][<span class="hljs-number">0</span>]+dp[y][<span class="hljs-number">0</span>];<br>	&#125;<br>	dp[x][<span class="hljs-number">0</span>]=<span class="hljs-built_in">max</span>(dp[x][<span class="hljs-number">0</span>],<span class="hljs-built_in">max</span>(dp[x][<span class="hljs-number">1</span>]+(node)&#123;-mid,<span class="hljs-number">1</span>&#125;,dp[x][<span class="hljs-number">2</span>]));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x,y,z;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);m++;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;x,&amp;y,&amp;z),<span class="hljs-built_in">Add</span>(x,y,z);<br>		r+= x&gt;<span class="hljs-number">0</span>? x:<span class="hljs-number">0</span>;<br>	&#125;<br>	l=-r;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">while</span>(l&lt;=r)<br>	&#123;<br>		mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>		<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">if</span>(dp[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].y&lt;m) r=mid<span class="hljs-number">-1</span>;<br>		<span class="hljs-keyword">else</span> ans=mid,l=mid<span class="hljs-number">+1</span>;<br>	&#125;<br>	mid=ans;<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,dp[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>].x+mid*m);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="P5308-Akvizna"><a href="#P5308-Akvizna" class="headerlink" title="P5308 Akvizna"></a>P5308 Akvizna</h2><p>感觉应该没有黑，最难的还是证明凹凸性 <del><strong>(我不会)</strong></del> 。</p>
<p>现在就当作他是上凸的吧，直接上 $wqs$ 二分。考虑无限制的 $DP$ ，倒序求会好搞一点。$dp_i&#x3D;dp_j+\frac{i-j}{i}$ ，这玩意很显然是可以用斜率优化或者二分队列的。这样就做完了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ld long double</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,cnt[N];<br><span class="hljs-type">int</span> q[N],h,t;<br>ld dp[N],res,eps=<span class="hljs-number">1e-14</span>;<br><span class="hljs-function">ld <span class="hljs-title">slope</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<span class="hljs-keyword">return</span> (dp[y]-dp[x])/(y-x);&#125;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check</span><span class="hljs-params">(ld x)</span></span><br><span class="hljs-function"></span>&#123;<br>	h=t=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(h&lt;t&amp;&amp;<span class="hljs-built_in">slope</span>(q[h],q[h<span class="hljs-number">+1</span>])<span class="hljs-number">-1.0</span>/i&gt;eps) h++;<br>		cnt[i]=cnt[q[h]]<span class="hljs-number">+1</span>;<br>		dp[i]=dp[q[h]]<span class="hljs-number">+1.0</span>*(i-q[h])/i-x;<br>		<span class="hljs-keyword">while</span>(h&lt;t&amp;&amp;<span class="hljs-built_in">slope</span>(q[t<span class="hljs-number">-1</span>],q[t])-<span class="hljs-built_in">slope</span>(q[t],i)&lt;-eps) t--;<br>		q[++t]=i;<br>	&#125;<br>	res=dp[n]+m*x;<br>	<span class="hljs-keyword">return</span> cnt[n]&lt;m;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	ld l=<span class="hljs-number">0</span>,r=<span class="hljs-number">1e6</span>,mid,ans;<br>	<span class="hljs-keyword">while</span>(l&lt;=r-eps)<br>	&#123;<br>		mid=(l+r)/<span class="hljs-number">2</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-built_in">check</span>(mid)) r=mid-eps;<br>		<span class="hljs-keyword">else</span> ans=mid,l=mid+eps;<br>	&#125;<br>	<span class="hljs-built_in">check</span>(ans);<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%.9Lf&quot;</span>,res);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="P2056-捉迷藏"><a href="#P2056-捉迷藏" class="headerlink" title="P2056 捉迷藏"></a>P2056 捉迷藏</h2><p>一开始以为括号序列就只是括号序列，没想到居然还能求这玩意。</p>
<p>对于这棵树</p>
<p><img src="https://i.loli.net/2018/07/28/5b5c0a750c492.png" srcset="/img/loading.gif" lazyload></p>
<p>括号序列是 $ [A[B[E][F[H][I]]][C][D[G]]]$</p>
<p>去掉字母就是 $[[[][[][]]][][[]]]$</p>
<p>对于 $F$ 和 $G$ 他们之间的括号序列就是 $[][]]][][[$ ，匹配之后就是 $]][[$ ，长度就是 $dis_{F\rightarrow G}$ ，其实也很好理解左括号就是向下走，右括号向上走。</p>
<p>我们把这个序列用线段树维护。设区间左，右括号个数为 $a$ 和 $b$ ，那么区间直径其实就是 $\max{b_1+a_2+|a_1-b_2|}&#x3D;\max{(a_1+b_1)+(a_2-b_2),(b_1-a_1)+(a_2+b_2)}$ 。直接分别求前缀的 $l_1&#x3D;a+b$ ， $l_2&#x3D;a-b$ ，后缀的 $r_1&#x3D;a+b$ ， $r_2&#x3D;b-a$ 的最大值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> lc k&lt;&lt;1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> rc k&lt;&lt;1|1</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e6</span><span class="hljs-number">+5</span>,M=<span class="hljs-number">1e6</span><span class="hljs-number">+5</span>,inf=<span class="hljs-number">1e9</span>;<br><span class="hljs-type">int</span> n,m,tot,head[M],nex[M&lt;&lt;<span class="hljs-number">1</span>],v[M&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> cnt,sum,pos[M],s[N],op[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> a,b,dis;<br>	<span class="hljs-type">int</span> l1,l2,r1,r2;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];head[x]=tot;v[tot]=y;<br>	nex[++tot]=head[y];head[y]=tot;v[tot]=x;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span></span><br><span class="hljs-function"></span>&#123;<br>	s[++cnt]=<span class="hljs-number">-1</span>;s[++cnt]=x;pos[x]=cnt;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		<span class="hljs-keyword">if</span>(v[i]^fa) <span class="hljs-built_in">dfs</span>(v[i],x);<br>	s[++cnt]=<span class="hljs-number">-2</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k]=(node)&#123;<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,-inf,-inf,-inf,-inf,-inf&#125;;<br>	<span class="hljs-keyword">if</span>(s[x]==<span class="hljs-number">-1</span>) t[k].a=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(s[x]==<span class="hljs-number">-2</span>) t[k].b=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!op[x]) t[k].l1=t[k].l2=t[k].r1=t[k].r2=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(t[lc].a&gt;t[rc].b)<br>		t[k].a=t[lc].a+t[rc].a-t[rc].b,t[k].b=t[lc].b;<br>	<span class="hljs-keyword">else</span> t[k].a=t[rc].a,t[k].b=t[lc].b+t[rc].b-t[lc].a;<br>	t[k].dis=<span class="hljs-built_in">max</span>(t[lc].dis,t[rc].dis);<br>	t[k].dis=<span class="hljs-built_in">max</span>(t[k].dis,<span class="hljs-built_in">max</span>(t[lc].r1+t[rc].l2,t[lc].r2+t[rc].l1));<br>	t[k].l1=<span class="hljs-built_in">max</span>(t[lc].l1,<span class="hljs-built_in">max</span>(t[lc].a+t[lc].b+t[rc].l2,-t[lc].a+t[lc].b+t[rc].l1));<br>	t[k].l2=<span class="hljs-built_in">max</span>(t[lc].l2,t[lc].a-t[lc].b+t[rc].l2);<br>	t[k].r1=<span class="hljs-built_in">max</span>(t[rc].r1,<span class="hljs-built_in">max</span>(t[lc].r1+t[rc].a-t[rc].b,t[lc].r2+t[rc].a+t[rc].b));<br>	t[k].r2=<span class="hljs-built_in">max</span>(t[rc].r2,t[lc].r2-t[rc].a+t[rc].b);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> <span class="hljs-built_in">update</span>(k,l),<span class="hljs-built_in">void</span>();<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> <span class="hljs-built_in">update</span>(k,x),<span class="hljs-built_in">void</span>();<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">char</span> ch;<br>	<span class="hljs-type">int</span> x,y;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	sum=n;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++) <br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y),<span class="hljs-built_in">Add</span>(x,y);<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,cnt);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;m);<br>	<span class="hljs-keyword">while</span>(m--)<br>	&#123;<br>		ch=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-keyword">while</span>(ch!=<span class="hljs-string">&#x27;G&#x27;</span>&amp;&amp;ch!=<span class="hljs-string">&#x27;C&#x27;</span>) ch=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-keyword">if</span>(ch==<span class="hljs-string">&#x27;G&#x27;</span>) <br>		&#123;<br>			<span class="hljs-keyword">if</span>(!sum) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;-1&quot;</span>);<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sum==<span class="hljs-number">1</span>) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0&quot;</span>);<br>			<span class="hljs-keyword">else</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,t[<span class="hljs-number">1</span>].dis);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <br>		&#123;<br>	    	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>			op[pos[x]]^=<span class="hljs-number">1</span>;<br>			sum+= op[pos[x]] ?<span class="hljs-number">-1</span>:<span class="hljs-number">1</span>;<br>			<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,cnt,pos[x]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="QTREE4-Query-on-a-tree-IV"><a href="#QTREE4-Query-on-a-tree-IV" class="headerlink" title="QTREE4 - Query on a tree IV"></a>QTREE4 - Query on a tree IV</h2><p>这题做法真多。。。</p>
<p>这题是<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/blog/229388/p2056-zhuo-mi-zang"><strong>捉迷藏</strong></a>的加强版，因为有负边权，所以括号序列会寄，被迫学了发树剖做法，感觉收获很多。</p>
<p>我们对每条重连建一棵线段树，为什么？<del>(因为我懒)</del> 。因为这样常数小，而且不用写询问的函数。</p>
<p>我们对每个区间 $[l,r]$ 维护他的最长链 $mx$ ，所有白点到达 $l$ 的最大距离 $lmax$ ，所有白点到达 $r$ 的最大距离 $rmax$ 。 </p>
<p>$pushup$ </p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,lc=t[k].lc,rc=t[k].rc;<br>	t[k].mx=<span class="hljs-built_in">max</span>(t[lc].mx,t[rc].mx);<br>	t[k].mx=<span class="hljs-built_in">max</span>(t[k].mx,t[lc].rmx+t[rc].lmx+dep[dfn[mid<span class="hljs-number">+1</span>]]-dep[dfn[mid]]);<br>	t[k].lmx=<span class="hljs-built_in">max</span>(t[lc].lmx,dep[dfn[mid<span class="hljs-number">+1</span>]]-dep[dfn[l]]+t[rc].lmx);<br>	t[k].rmx=<span class="hljs-built_in">max</span>(t[rc].rmx,dep[dfn[r]]-dep[dfn[mid]]+t[lc].rmx);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>现在关键就在怎么求出叶子节点的初始值。其实我们只考虑链经过轻儿子的情况就好了，因为经过他的父亲和重儿子的情况都会在别的情况里面算到。所以我们可以拿个 $set$ 来存每个点轻儿子的值就行了。</p>
<p>对于修改影响的只有到根路径上的点，一条条重链调就好了。答案就再拿一个 $set$ 存就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;set&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+5</span>,inf=<span class="hljs-number">1e9</span>;<br><span class="hljs-type">int</span> n,q,tot,cnt,sum,head[N],nex[N&lt;&lt;<span class="hljs-number">1</span>],v[N&lt;&lt;<span class="hljs-number">1</span>],w[N&lt;&lt;<span class="hljs-number">1</span>],op[N];<br><span class="hljs-type">int</span> rt[N],id[N],ed[N],dfn[N],son[N],siz[N],dep[N],f[N],top[N];<br>multiset&lt;<span class="hljs-type">int</span>&gt;s[N],all;<br>multiset&lt;<span class="hljs-type">int</span>&gt;::iterator it;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> lc,rc,mx,lmx,rmx;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];head[x]=tot;v[tot]=y;w[tot]=z;<br>	nex[++tot]=head[y];head[y]=tot;v[tot]=x;w[tot]=z;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Top</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	it=s[x].<span class="hljs-built_in">end</span>();<br>	<span class="hljs-keyword">if</span>(it==s[x].<span class="hljs-built_in">begin</span>()) <span class="hljs-keyword">return</span> -inf;<br>	<span class="hljs-keyword">return</span> *(--it);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Del</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	it=s[x].<span class="hljs-built_in">find</span>(y);<br>	s[x].<span class="hljs-built_in">erase</span>(it);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">Calc</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> res=<span class="hljs-number">0</span>;<br>	it=s[x].<span class="hljs-built_in">end</span>();<br>	<span class="hljs-keyword">if</span>(it!=s[x].<span class="hljs-built_in">begin</span>()) res+=*(--it);<br>	<span class="hljs-keyword">if</span>(it!=s[x].<span class="hljs-built_in">begin</span>()) res+=*(--it);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,lc=t[k].lc,rc=t[k].rc;<br>	t[k].mx=<span class="hljs-built_in">max</span>(t[lc].mx,t[rc].mx);<br>	t[k].mx=<span class="hljs-built_in">max</span>(t[k].mx,t[lc].rmx+t[rc].lmx+dep[dfn[mid<span class="hljs-number">+1</span>]]-dep[dfn[mid]]);<br>	t[k].lmx=<span class="hljs-built_in">max</span>(t[lc].lmx,dep[dfn[mid<span class="hljs-number">+1</span>]]-dep[dfn[l]]+t[rc].lmx);<br>	t[k].rmx=<span class="hljs-built_in">max</span>(t[rc].rmx,dep[dfn[r]]-dep[dfn[mid]]+t[lc].rmx);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!k) k=++tot;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		<span class="hljs-type">int</span> x=dfn[l];<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>			<span class="hljs-keyword">if</span>(v[i]!=f[x]&amp;&amp;v[i]!=son[x]) s[x].<span class="hljs-built_in">insert</span>(t[rt[v[i]]].lmx+dep[v[i]]-dep[x]);<br>		s[x].<span class="hljs-built_in">insert</span>(<span class="hljs-number">0</span>);<br>		t[k].lmx=t[k].rmx=<span class="hljs-built_in">Top</span>(x);<br>		t[k].mx=<span class="hljs-built_in">Calc</span>(x);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(t[k].lc,l,mid);<span class="hljs-built_in">build</span>(t[k].rc,mid<span class="hljs-number">+1</span>,r);<br>	<span class="hljs-built_in">pushup</span>(k,l,r);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		t[k].lmx=t[k].rmx=<span class="hljs-built_in">Top</span>(dfn[l]);<br>		t[k].mx=<span class="hljs-built_in">Calc</span>(dfn[l]);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(t[k].lc,l,mid,x);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">modify</span>(t[k].rc,mid<span class="hljs-number">+1</span>,r,x);<br>	<span class="hljs-built_in">pushup</span>(k,l,r);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span></span><br><span class="hljs-function"></span>&#123;<br>	f[x]=fa;siz[x]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		<span class="hljs-keyword">if</span>(v[i]^fa) <br>		&#123;<br>	    	dep[v[i]]=dep[x]+w[i];<br>			<span class="hljs-built_in">dfs1</span>(v[i],x);<br>			<span class="hljs-keyword">if</span>(siz[son[x]]&lt;siz[v[i]]) son[x]=v[i];<br>			siz[x]+=siz[v[i]];<br>		&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	id[x]=++cnt;dfn[cnt]=x;<br>	ed[top[x]]=cnt;<br>	<span class="hljs-keyword">if</span>(son[x])<br>		top[son[x]]=top[x],<span class="hljs-built_in">dfs2</span>(son[x]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		<span class="hljs-keyword">if</span>(!top[v[i]]) top[v[i]]=v[i],<span class="hljs-built_in">dfs2</span>(v[i]);<br>	<span class="hljs-keyword">if</span>(top[x]==x) <span class="hljs-built_in">build</span>(rt[x],id[x],ed[x]),all.<span class="hljs-built_in">insert</span>(t[rt[x]].mx);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	op[x]^=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(op[x]) <span class="hljs-built_in">Del</span>(x,<span class="hljs-number">0</span>),sum--;<br>	<span class="hljs-keyword">else</span> s[x].<span class="hljs-built_in">insert</span>(<span class="hljs-number">0</span>),sum++;<br>	<span class="hljs-type">int</span> fx=top[x];<br>	<span class="hljs-keyword">while</span>(x)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(f[fx]) <span class="hljs-built_in">Del</span>(f[fx],t[rt[fx]].lmx+dep[fx]-dep[f[fx]]);<br>		it=all.<span class="hljs-built_in">find</span>(t[rt[fx]].mx);<br>		all.<span class="hljs-built_in">erase</span>(it);<br>		<span class="hljs-built_in">modify</span>(rt[fx],id[fx],ed[fx],id[x]);<br>		all.<span class="hljs-built_in">insert</span>(t[rt[fx]].mx);<br>		<span class="hljs-keyword">if</span>(f[fx]) s[f[fx]].<span class="hljs-built_in">insert</span>(t[rt[fx]].lmx+dep[fx]-dep[f[fx]]);<br>		x=f[fx];fx=top[x];<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">char</span> ch;<br>	<span class="hljs-type">int</span> x,y,z;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	sum=n;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;x,&amp;y,&amp;z),<span class="hljs-built_in">Add</span>(x,y,z);<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	top[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;tot=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;q);<br>	<span class="hljs-keyword">while</span>(q--)<br>	&#123;<br>		ch=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-keyword">while</span>(ch!=<span class="hljs-string">&#x27;A&#x27;</span>&amp;&amp;ch!=<span class="hljs-string">&#x27;C&#x27;</span>) ch=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-keyword">if</span>(ch==<span class="hljs-string">&#x27;A&#x27;</span>)<br>		&#123;<br>			<span class="hljs-keyword">if</span>(!sum) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;They have disappeared.&quot;</span>);<br>			<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(sum==<span class="hljs-number">1</span>) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0&quot;</span>);<br>			<span class="hljs-keyword">else</span> it=all.<span class="hljs-built_in">end</span>(),<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,*(--it));<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x),<span class="hljs-built_in">modify</span>(x);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="P3345-幻想乡战略游戏"><a href="#P3345-幻想乡战略游戏" class="headerlink" title="P3345  幻想乡战略游戏"></a>P3345  幻想乡战略游戏</h2><p>重心居然与边权大小无关。。。我是菜狗。</p>
<p>我们考虑先假设以 $1$ 为重心，重心 $x$ 转移到儿子 $y$ 产生的贡献就是 $(tot-2\times size_y)\times w_{x,y}$ ，即当 $2\times size_y \ge tot$ 时 $y$ 会比 $x$ 更优。因为满足条件的点肯定是在同一条重链上的，我们直接可以在线段树上二分找到重心。</p>
<p>确定重心以后就是很简单的查询一个点到所有点的距离了，这里就不讲了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,tot,head[N],nex[N&lt;&lt;<span class="hljs-number">1</span>],v[N&lt;&lt;<span class="hljs-number">1</span>],w[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> cnt,id[N],dfn[N],dep[N],val[N],top[N],f[N],son[N],siz[N];<br>ll sum,ans;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> mx,tag;<br>	ll s,sum;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];head[x]=tot;v[tot]=y;w[tot]=z;<br>	nex[++tot]=head[y];head[y]=tot;v[tot]=x;w[tot]=z;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs1</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> fa)</span></span><br><span class="hljs-function"></span>&#123;<br>	f[x]=fa;siz[x]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		<span class="hljs-keyword">if</span>(v[i]^fa)<br>		&#123;<br>			val[v[i]]=w[i];<br>			dep[v[i]]=dep[x]+w[i];<br>			<span class="hljs-built_in">dfs1</span>(v[i],x);<br>			<span class="hljs-keyword">if</span>(siz[v[i]]&gt;siz[son[x]]) son[x]=v[i];<br>			siz[x]+=siz[v[i]];<br>		&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs2</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	id[x]=++cnt;dfn[cnt]=x;<br>	<span class="hljs-keyword">if</span>(son[x])<br>		top[son[x]]=top[x],<span class="hljs-built_in">dfs2</span>(son[x]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		<span class="hljs-keyword">if</span>(!top[v[i]]) top[v[i]]=v[i],<span class="hljs-built_in">dfs2</span>(v[i]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].tag+=val;t[k].mx+=val;<br>	t[k].s+=<span class="hljs-number">1ll</span>*val*t[k].sum;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].mx=<span class="hljs-built_in">max</span>(t[k&lt;&lt;<span class="hljs-number">1</span>].mx,t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].mx);<br>	t[k].sum=t[k&lt;&lt;<span class="hljs-number">1</span>].sum+t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].sum;<br>	t[k].s=t[k&lt;&lt;<span class="hljs-number">1</span>].s+t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].s;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">Add</span>(k&lt;&lt;<span class="hljs-number">1</span>,t[k].tag);<span class="hljs-built_in">Add</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,t[k].tag);<br>	t[k].tag=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)&#123;<span class="hljs-keyword">return</span> t[k].sum=val[dfn[l]],<span class="hljs-built_in">void</span>();&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Add</span>(k,val),<span class="hljs-built_in">void</span>();<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y,val);<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y,val);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-number">2</span>*t[k].mx&lt;val) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> dfn[l];<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> res=<span class="hljs-built_in">find</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,val);<br>	<span class="hljs-keyword">if</span>(!res) res=<span class="hljs-built_in">find</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,val);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> t[k].s;<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y)+<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">while</span>(x)<br>		<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,id[top[x]],id[x],val),x=f[top[x]];<br>	<span class="hljs-keyword">return</span> ;<br>&#125;<br><br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	ll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(x)<br>		res+=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,id[top[x]],id[x]),x=f[top[x]];<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x,y,z;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;x,&amp;y,&amp;z),<span class="hljs-built_in">Add</span>(x,y,z);<br>	<span class="hljs-built_in">dfs1</span>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);<br>	top[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">dfs2</span>(<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	tot=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">while</span>(m--)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		tot+=y;sum+=<span class="hljs-number">1ll</span>*y*dep[x];<br>		<span class="hljs-built_in">modify</span>(x,y);<br>		<span class="hljs-keyword">if</span>(!tot) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0&quot;</span>);<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			z=<span class="hljs-built_in">find</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,tot);<br>     	   	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-number">1ll</span>*tot*dep[z]+sum<span class="hljs-number">-2</span>*<span class="hljs-built_in">query</span>(z));<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1634F-Fibonacci-Additions"><a href="#CF1634F-Fibonacci-Additions" class="headerlink" title="CF1634F Fibonacci Additions"></a>CF1634F Fibonacci Additions</h2><p>感觉很妙的一题,不看题解感觉自己根本想不到。。。</p>
<p>我们考虑把两个数组差分得到 $c$ 数组，每次判断 $c$ 数组是否全为零就好。但 $Fib$ 不好搞，所以我们可以再构造一个 $d$ 数组，使得 $d_i&#x3D;c_i-c_{i-1}-c_{i-2}$ ，这样的花每次操作就是在 $d_l$ 加上 $Fib_1$ ，在 $d_{r+1}$ 减去 $Fib_{r-l+2}$ ，在 $d_{r+2}$ 加上 $Fib_{r-l+1}$ 。维护 $d$ 中 $0$ 的个数就好。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,q,mod,f[N];<br><span class="hljs-type">int</span> a[N],b[N],cnt;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&gt;n) <span class="hljs-keyword">return</span> ;<br>	cnt-=(b[x]!=<span class="hljs-number">0</span>);<br>	b[x]=((b[x]+val)%mod+mod)%mod;<br>	cnt+=(b[x]!=<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">char</span> op;<br>	<span class="hljs-type">int</span> x,y;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;q,&amp;mod);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <br>	&#123;<br>    	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>		a[i]=(a[i]-x+mod)%mod;<br>	&#125;<br>	f[<span class="hljs-number">1</span>]=f[<span class="hljs-number">2</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">3</span>;i&lt;=n;i++) f[i]=(f[i<span class="hljs-number">-1</span>]+f[i<span class="hljs-number">-2</span>])%mod;<br>	<span class="hljs-built_in">Add</span>(<span class="hljs-number">1</span>,a[<span class="hljs-number">1</span>]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n;i++) <br>		<span class="hljs-built_in">Add</span>(i,a[i]-a[i<span class="hljs-number">-1</span>]-a[i<span class="hljs-number">-2</span>]+mod);<br>	<span class="hljs-keyword">while</span>(q--)<br>	&#123;<br>		op=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-keyword">while</span>(op!=<span class="hljs-string">&#x27;A&#x27;</span>&amp;&amp;op!=<span class="hljs-string">&#x27;B&#x27;</span>) op=<span class="hljs-built_in">getchar</span>();<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;x,&amp;y);<br>		<span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;A&#x27;</span>)  <span class="hljs-built_in">Add</span>(x,<span class="hljs-number">1</span>),<span class="hljs-built_in">Add</span>(y<span class="hljs-number">+1</span>,-f[y-x<span class="hljs-number">+2</span>]),<span class="hljs-built_in">Add</span>(y<span class="hljs-number">+2</span>,-f[y-x<span class="hljs-number">+1</span>]);<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">Add</span>(x,<span class="hljs-number">-1</span>),<span class="hljs-built_in">Add</span>(y<span class="hljs-number">+1</span>,f[y-x<span class="hljs-number">+2</span>]),<span class="hljs-built_in">Add</span>(y<span class="hljs-number">+2</span>,f[y-x<span class="hljs-number">+1</span>]);<br>		<span class="hljs-keyword">if</span>(!cnt) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;YES&quot;</span>);<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1117G-Recursive-Queries"><a href="#CF1117G-Recursive-Queries" class="headerlink" title="CF1117G Recursive Queries"></a>CF1117G Recursive Queries</h2><p> 我们发现对于每个 $i$ ，设左边第一个比他大的数在 $L_i$ ，右边第一个比他大的数在 $R_i$ ，那么他的贡献就是 $\min(R_i-1,r)-\max(L_i+1,l)+1$</p>
<p> 所以我们求的就是 $\sum\limits_{i&#x3D;l}\limits^{r} \min(R_i-1,r)-\max(L_i+1,l)+1$ ， 这个显然可以离线下来，用扫描线和树状数组来求解。</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fir first</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> sec second</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e6</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,q,top,p[N],a[N],b[N];<br><span class="hljs-type">int</span> st[N],L[N],R[N];<br>ll cntl[N],cntr[N],fl[N],fr[N],ans[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> x,l,r,id,op;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt;(node <span class="hljs-type">const</span> &amp;b)<span class="hljs-type">const</span>&#123;<span class="hljs-keyword">return</span> x&lt;b.x;&#125;<br>&#125;s[N];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">lowbit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>&#123;<span class="hljs-keyword">return</span> x&amp;(-x);&#125;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(ll f[],<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span> </span>&#123;<span class="hljs-keyword">for</span>(;x&lt;=n;x+=<span class="hljs-built_in">lowbit</span>(x)) f[x]+=val;&#125;<br><span class="hljs-function">ll <span class="hljs-title">query</span><span class="hljs-params">(ll f[],<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	ll res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(;x;x-=<span class="hljs-built_in">lowbit</span>(x)) res+=f[x];<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function">ll <span class="hljs-title">calc</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	ll res=<span class="hljs-built_in">query</span>(fr,r)+r*(<span class="hljs-built_in">query</span>(cntr,n)-<span class="hljs-built_in">query</span>(cntr,r));<br>	res-=l*<span class="hljs-built_in">query</span>(cntl,l)+<span class="hljs-built_in">query</span>(fl,n)-<span class="hljs-built_in">query</span>(fl,l);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">inisert</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	L[x]++;R[x]--;<br>	<span class="hljs-built_in">update</span>(cntl,L[x],<span class="hljs-number">1</span>);<span class="hljs-built_in">update</span>(cntr,R[x],<span class="hljs-number">1</span>);<br>	<span class="hljs-built_in">update</span>(fl,L[x],L[x]);<span class="hljs-built_in">update</span>(fr,R[x],R[x]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;q);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;p[i]);<br>		<span class="hljs-keyword">while</span>(top&amp;&amp;p[i]&gt;p[st[top]])<br>			R[st[top--]]=i;<br>		L[i]=st[top];st[++top]=i;<br>	&#125;<br>	<span class="hljs-keyword">while</span>(top) R[st[top--]]=n<span class="hljs-number">+1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;b[i]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(a[i]&gt;<span class="hljs-number">1</span>) s[++m]=(node)&#123;a[i]<span class="hljs-number">-1</span>,a[i],b[i],i,<span class="hljs-number">-1</span>&#125;;<br>		s[++m]=(node)&#123;b[i],a[i],b[i],i,<span class="hljs-number">1</span>&#125;;<br>		ans[i]=b[i]-a[i]<span class="hljs-number">+1</span>;<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(s<span class="hljs-number">+1</span>,s<span class="hljs-number">+1</span>+m);<br>	<span class="hljs-type">int</span> now=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-built_in">inisert</span>(i);<br>		<span class="hljs-keyword">while</span>(s[now].x==i)<br>		&#123;<br>			ans[s[now].id]+=<span class="hljs-built_in">calc</span>(s[now].l,s[now].r)*s[now].op;<br>			now++;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=q;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld &quot;</span>,ans[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1004F-Sonya-and-Bitwise-OR"><a href="#CF1004F-Sonya-and-Bitwise-OR" class="headerlink" title="CF1004F Sonya and Bitwise OR"></a>CF1004F Sonya and Bitwise OR</h2><p><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4435">双倍经验</a>。我是菜只因。</p>
<p>我们考虑分治。对于一个区间 $[l,r]$ ，我们先计算区间 $[l,mid]$ 和 $[mid+1,r]$ 的答案。接着只用求左右端点分别在两个区间中的答案了，用 $two-pointer$ 就好了。但这样是 $O(mn \log x)$ 的。</p>
<p>但我们发现对于一个区间，他的前缀或起来的值只有 $\log x$ 种，所以我们可以用 $vector$ 存一下前缀和后缀的分段情况。这些东西都是可以在线段树上处理的。复杂度就是 $O(n\log x+m\log n\log x)$ 。</p>
<p>以后看到区间或，区间与，区间 $\gcd$ 都可以往段数是 $\log$ 级别的方面想一想。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fir first</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> sec second</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mkp make_pair</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pii pair<span class="hljs-string">&lt;int,int&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,lim,a[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> l,r;<br>	ll ans;<br>	vector&lt;pii&gt; pre,suf;<br>	<span class="hljs-built_in">node</span>()&#123;ans=<span class="hljs-number">0</span>;pre.<span class="hljs-built_in">clear</span>();suf.<span class="hljs-built_in">clear</span>();&#125;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function">node <span class="hljs-title">Merge</span><span class="hljs-params">(node lc,node rc)</span></span><br><span class="hljs-function"></span>&#123;<br>	node c;<br>	c.ans=lc.ans+rc.ans;<br>	c.l=lc.l;c.r=rc.r;<br>	<span class="hljs-type">int</span> j=rc.pre.<span class="hljs-built_in">size</span>(),lst=lc.r<span class="hljs-number">+1</span>,ed;<br>	j--;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;lc.suf.<span class="hljs-built_in">size</span>();i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(j<span class="hljs-number">-1</span>&gt;=<span class="hljs-number">0</span>&amp;&amp;(lc.suf[i].sec|rc.pre[j<span class="hljs-number">-1</span>].sec)&gt;=lim) j--;<br>		<span class="hljs-keyword">if</span>((lc.suf[i].sec|rc.pre[j].sec)&lt;lim)<br>		&#123;<br>			lst=lc.suf[i].fir;<br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		c.ans+=<span class="hljs-number">1ll</span>*(lst-lc.suf[i].fir)*(rc.r-rc.pre[j].fir<span class="hljs-number">+1</span>);<br>		lst=lc.suf[i].fir;<br>	&#125;<br>	c.pre=lc.pre;c.suf=rc.suf;<br>	ed=lc.pre.<span class="hljs-built_in">size</span>();ed--;<br>	j=lst=lc.pre[ed].sec;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;rc.pre.<span class="hljs-built_in">size</span>();i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(i&lt;rc.pre.<span class="hljs-built_in">size</span>()&amp;&amp;lst==(rc.pre[i].sec|j)) i++;<br>		<span class="hljs-keyword">if</span>(i&lt;rc.pre.<span class="hljs-built_in">size</span>())<br>		&#123;<br>			lst=rc.pre[i].sec|j;<br>			c.pre.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">mkp</span>(rc.pre[i].fir,lst));<br>		&#125;<br>	&#125;<br>	ed=rc.suf.<span class="hljs-built_in">size</span>();ed--;<br>	j=lst=rc.suf[ed].sec;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;lc.suf.<span class="hljs-built_in">size</span>();i++)<br>	&#123;<br>		<span class="hljs-keyword">while</span>(i&lt;lc.suf.<span class="hljs-built_in">size</span>()&amp;&amp;lst==(lc.suf[i].sec|j)) <br>	    	c.suf[ed].fir=lc.suf[i].fir,i++;<br>		<span class="hljs-keyword">if</span>(i&lt;lc.suf.<span class="hljs-built_in">size</span>())<br>		&#123;<br>			lst=lc.suf[i].sec|j;<br>			c.suf.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">mkp</span>(lc.suf[i].fir,lst));<br>			ed++;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[l]);<br>		t[k].ans=(a[l]&gt;=lim);<br>		t[k].l=t[k].r=l;<br>		t[k].pre.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">mkp</span>(l,a[l]));<br>		t[k].suf.<span class="hljs-built_in">push_back</span>(<span class="hljs-built_in">mkp</span>(l,a[l]));<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>	t[k]=<span class="hljs-built_in">Merge</span>(t[k&lt;&lt;<span class="hljs-number">1</span>],t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		t[k].ans=(val&gt;=lim);<br>		t[k].pre[<span class="hljs-number">0</span>]=<span class="hljs-built_in">mkp</span>(l,val);t[k].suf[<span class="hljs-number">0</span>]=<span class="hljs-built_in">mkp</span>(l,val);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,val);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,val);<br>	t[k]=<span class="hljs-built_in">Merge</span>(t[k&lt;&lt;<span class="hljs-number">1</span>],t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>]);<br>&#125;<br><br><span class="hljs-function">node <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> L,<span class="hljs-type">int</span> R)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R) <span class="hljs-keyword">return</span> t[k];<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(R&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,L,R);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(L&gt;mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,L,R);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">Merge</span>(<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,L,R),<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,L,R));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> op,x,y;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;m,&amp;lim);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">while</span>(m--)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;op,&amp;x,&amp;y);<br>		<span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y);<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y).ans);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF765F-Souvenirs"><a href="#CF765F-Souvenirs" class="headerlink" title="CF765F  Souvenirs"></a>CF765F  Souvenirs</h2><p>绝对值很好处理，我们只考虑 $j&lt;i$ 且 $a_j&lt;&#x3D;a_i$ 的数对，翻转完后再做以便就好。</p>
<p>我们考虑离线下来，从左往右扫的时候维护每个后缀的答案。最暴力的做法就是 $O(n^2)$ 。</p>
<p>我们考虑减少一下决策情况，对于 $k&lt;j&lt;i$ ，只有在 $a_i-a_k&lt;a_k-a_j$ 的时候 $[k,i]$ 这段后缀的最小值才会发生改变。</p>
<p>这样的情况数就降低到了 $\log V$ 级别的，每次找 $k$ 直接开一颗权值线段树就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">3e5</span><span class="hljs-number">+5</span>,inf=<span class="hljs-number">1e9</span>;<br><span class="hljs-type">int</span> n,m,a[N],ans[N];<br><span class="hljs-type">int</span> rt,cnt,ls[N*<span class="hljs-number">20</span>],rs[N*<span class="hljs-number">20</span>],mx[N*<span class="hljs-number">20</span>];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> l,r,id;<br>	<span class="hljs-type">bool</span> <span class="hljs-keyword">operator</span> &lt;(<span class="hljs-type">const</span> node &amp;b)&#123;<span class="hljs-keyword">return</span> r&lt;b.r;&#125;<br>&#125;s[N];<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Seg</span><br>&#123;<br>	<span class="hljs-type">int</span> tag,s;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].s=<span class="hljs-built_in">min</span>(t[k&lt;&lt;<span class="hljs-number">1</span>].s,t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>].s);<br>	t[k].s=<span class="hljs-built_in">min</span>(t[k].s,t[k].tag);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k]=(Seg)&#123;inf,inf&#125;;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <br>	&#123;<br>    	t[k].tag=<span class="hljs-built_in">min</span>(t[k].tag,val);<br>		t[k].s=<span class="hljs-built_in">min</span>(t[k].s,val);<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(l&gt;y||r&lt;x) <span class="hljs-keyword">return</span>;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y,val);<span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y,val);<br>	<span class="hljs-built_in">pushup</span>(k);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> t[k].s;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-type">int</span> res;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>	<span class="hljs-keyword">else</span> res=<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(res,t[k].tag);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> v)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!k) k=++cnt;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> mx[k]=v,<span class="hljs-built_in">void</span>();<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">insert</span>(ls[k],l,mid,x,v);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">insert</span>(rs[k],mid<span class="hljs-number">+1</span>,r,x,v);<br>	mx[k]=<span class="hljs-built_in">max</span>(mx[ls[k]],mx[rs[k]]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">find</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> L,<span class="hljs-type">int</span> R)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(!k||l&gt;R||r&lt;L) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span>(L&lt;=l&amp;&amp;r&lt;=R) <span class="hljs-keyword">return</span> mx[k];<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">max</span>(<span class="hljs-built_in">find</span>(ls[k],l,mid,L,R),<span class="hljs-built_in">find</span>(rs[k],mid<span class="hljs-number">+1</span>,r,L,R));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	rt=cnt=<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">memset</span>(ls,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(ls));<br>	<span class="hljs-built_in">memset</span>(rs,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(rs));<br>	<span class="hljs-built_in">memset</span>(mx,<span class="hljs-number">0</span>,<span class="hljs-built_in">sizeof</span>(mx));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">solve</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-type">int</span> now=<span class="hljs-number">1</span>,x,lst;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		x=<span class="hljs-built_in">find</span>(rt,<span class="hljs-number">0</span>,inf,<span class="hljs-number">0</span>,a[i]);<br>		<span class="hljs-keyword">while</span>(x)<br>		&#123;<br>			lst=x;<br>			x=<span class="hljs-built_in">find</span>(rt,<span class="hljs-number">0</span>,inf,(a[x]+a[i])/<span class="hljs-number">2</span><span class="hljs-number">+1</span>,a[i]);<br>			<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x<span class="hljs-number">+1</span>,lst,a[i]-a[lst]);<br>		&#125;<br>		<span class="hljs-built_in">insert</span>(rt,<span class="hljs-number">0</span>,inf,a[i],i);<br>		<span class="hljs-keyword">while</span>(s[now].r==i)<br>			ans[s[now].id]=<span class="hljs-built_in">min</span>(ans[s[now].id],<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,s[now].l)),now++;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]);<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;m);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) <br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;s[i].l,&amp;s[i].r);<br>		s[i].id=i;ans[i]=inf;<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(s<span class="hljs-number">+1</span>,s<span class="hljs-number">+1</span>+m);<br>	<span class="hljs-built_in">solve</span>();<br>	<span class="hljs-built_in">reverse</span>(a<span class="hljs-number">+1</span>,a<span class="hljs-number">+1</span>+n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>	&#123;<br>		s[i].l=n-s[i].l<span class="hljs-number">+1</span>;<br>		s[i].r=n-s[i].r<span class="hljs-number">+1</span>;<br>		<span class="hljs-built_in">swap</span>(s[i].l,s[i].r);<br>	&#125;<br>	<span class="hljs-built_in">sort</span>(s<span class="hljs-number">+1</span>,s<span class="hljs-number">+1</span>+m);<br>	<span class="hljs-built_in">solve</span>();<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,ans[i]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="P8367-LNOI2022-盒"><a href="#P8367-LNOI2022-盒" class="headerlink" title="P8367 [LNOI2022] 盒"></a>P8367 [LNOI2022] 盒</h2><p>考虑给了 $b$ 怎么搞。设 $c_i$ 和 $d_i$ 分别是 $a$ 和 $b$ 的前缀和。</p>
<p>很明显答案就是 $\sum\limits_{i&#x3D;1}^{n-1}w_i|c_i-d_i|$</p>
<p>那么 $40pts$ 是很好拿得 $ans&#x3D;\sum\limits_{i&#x3D;1}^{n-1}w_i\sum\limits_{j&#x3D;0}^{S}|j-c_i|{j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}$ </p>
<p>本质就是要算 $res_i&#x3D;\sum\limits_{j&#x3D;0}^{S}|j-c_i|{j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}$ 。</p>
<p>先把绝对值去掉 $res_i&#x3D;2\sum\limits_{j&#x3D;0}^{c_i}(c_i-j){j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}+\sum\limits_{j&#x3D;0}^{S}(j-c_i){j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}$</p>
<p>然后我们发现他其实就是要求 $f(n,S,i,k)&#x3D;\sum\limits_{j&#x3D;0}^{k}{j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}$ 和 $g(n,S,i,k)&#x3D;\sum\limits_{j&#x3D;0}^k j{j+i-1\choose i-1}{n-i+S-j-1\choose n-i-1}$</p>
<p><del>然后我就不会了。</del></p>
<p>我们发现 $j{j+i-1\choose i-1}&#x3D;\frac{(j+i-1)!}{(i-1)!(j-1)!}&#x3D;i{j+i-1\choose i}$</p>
<p>所以 $g(n,S,i,k)&#x3D;i\sum\limits_{j&#x3D;0}^k{j+i-1\choose i}{n-i+S-j-1\choose n-i-1}&#x3D;i\times f(n+1,S-1,i+1,k-1)$</p>
<p>所以我们求 $f(n,S,i,k)$ 就好了。</p>
<p>我们发现 $i,k$ 每次都是单调递增的，所以每次暴力把 $i,k$ 加一，复杂度是 $O(n+S)$ 的。</p>
<p>$k$ 加一很好搞，主要是 $i$ 加一不好搞。</p>
<p>我们考虑一下 $f(n,m,i,k)$ 的组合意义是让前 $i$ 个盒子的小球总和 $\le k$ 那，等价于第 $k+1$ 个小球不再前 $i$ 个盒子中，所以 $f(n,m,i,k)&#x3D;\sum\limits_{j&#x3D;i+1}^n{j+k-1\choose j-1}{n-j+m-k-1\choose n-j}$，这样移动 $i$ 就很好处理了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e6</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n,m,a[N],w[N],ans,res;<br><span class="hljs-type">int</span> fac[N&lt;&lt;<span class="hljs-number">1</span>],invf[N&lt;&lt;<span class="hljs-number">1</span>];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;y||x&lt;<span class="hljs-number">0</span>||y&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1ll</span>*fac[x]*invf[y]%mod*invf[x-y]%mod;<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> n,m,i,k,sum;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">(<span class="hljs-type">int</span> _n,<span class="hljs-type">int</span> _m,<span class="hljs-type">int</span> _i,<span class="hljs-type">int</span> _k)</span></span><br><span class="hljs-function">	</span>&#123;<br>		n=_n;m=_m;i=_i;k=_k;<br>		sum=<span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;=k;j++)<br>			sum=(sum<span class="hljs-number">+1ll</span>*<span class="hljs-built_in">C</span>(i+j<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>)*<span class="hljs-built_in">C</span>(n-i+m-j<span class="hljs-number">-1</span>,n-i<span class="hljs-number">-1</span>)%mod)%mod;<br>	&#125;<br>	<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">move</span><span class="hljs-params">(<span class="hljs-type">int</span> _i,<span class="hljs-type">int</span> _k)</span></span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-keyword">while</span>(k&lt;_k)<br>			k++,sum=(sum<span class="hljs-number">+1ll</span>*<span class="hljs-built_in">C</span>(i+k<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>)*<span class="hljs-built_in">C</span>(n-i+m-k<span class="hljs-number">-1</span>,n-i<span class="hljs-number">-1</span>)%mod)%mod;<br>		<span class="hljs-keyword">while</span>(i&lt;_i)<br>			i++,sum=(sum<span class="hljs-number">-1ll</span>*<span class="hljs-built_in">C</span>(i+k<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>)*<span class="hljs-built_in">C</span>(m-k<span class="hljs-number">-1</span>+n-i,n-i)%mod)%mod;<br>	&#125;<br><br>&#125;s1,s2,s3,s4;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=invf[<span class="hljs-number">0</span>]=invf[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">4e6</span>;i++)<br>	&#123;<br>		fac[i]=<span class="hljs-number">1ll</span>*fac[i<span class="hljs-number">-1</span>]*i%mod;<br>		invf[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*invf[mod%i]%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">4e6</span>;i++)<br>		invf[i]=<span class="hljs-number">1ll</span>*invf[i]*invf[i<span class="hljs-number">-1</span>]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> T;<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;T);<br>	<span class="hljs-keyword">while</span>(T--)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]),a[i]+=a[i<span class="hljs-number">-1</span>];<br>		m=a[n];ans=<span class="hljs-number">0</span>;<br>		s<span class="hljs-number">1.</span><span class="hljs-built_in">init</span>(n,m,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>);s<span class="hljs-number">2.</span><span class="hljs-built_in">init</span>(n<span class="hljs-number">+1</span>,m<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>);<br>		s<span class="hljs-number">3.</span><span class="hljs-built_in">init</span>(n,m,<span class="hljs-number">1</span>,m);s<span class="hljs-number">4.</span><span class="hljs-built_in">init</span>(n<span class="hljs-number">+1</span>,m<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>,m<span class="hljs-number">-1</span>);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;n;i++) <br>		&#123;<br>			<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;w[i]);<br>			s<span class="hljs-number">1.</span><span class="hljs-built_in">move</span>(i,a[i]);s<span class="hljs-number">2.</span><span class="hljs-built_in">move</span>(i<span class="hljs-number">+1</span>,a[i]<span class="hljs-number">-1</span>);<br>			s<span class="hljs-number">3.</span><span class="hljs-built_in">move</span>(i,m);s<span class="hljs-number">4.</span><span class="hljs-built_in">move</span>(i<span class="hljs-number">+1</span>,m<span class="hljs-number">-1</span>);<br>     		res=<span class="hljs-number">2ll</span>*a[i]*s<span class="hljs-number">1.</span>sum%mod;<br>			res=(res<span class="hljs-number">-2ll</span>*i*s<span class="hljs-number">2.</span>sum%mod)%mod;<br>			res=(res<span class="hljs-number">-1ll</span>*a[i]*s<span class="hljs-number">3.</span>sum%mod)%mod;<br>			res=(res<span class="hljs-number">+1ll</span>*i*s<span class="hljs-number">4.</span>sum%mod)%mod;<br>			ans=(ans<span class="hljs-number">+1ll</span>*w[i]*res%mod)%mod;<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,(ans+mod)%mod);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1129D-Isolation"><a href="#CF1129D-Isolation" class="headerlink" title="CF1129D Isolation"></a>CF1129D Isolation</h2><p>居然有这么简单的黑。</p>
<p>如何判断后缀中有多少个只出现过一次非常的典，维护一下后缀和 $suf$ 就好。这样就可以有一个 $O(n^2)$ 的朴素 $dp$ 了。</p>
<p>考虑用 $DS$ 维护一下 $suf$ 和 $suf\le k$ 的 $dp$ 值的和，感觉没有什么 $log$ 的玩意可以维护这个，那就大胆尝试分块，给每个块维护一个桶 $suf$ 为 $i$ 存 $dp$ 值 。每次加减都等于桶整体左移右移，那个一个指针维护一下当前<br>$suf&#x3D;k$ 的值原来对应的位置。因为加减的次数是 $O(n)$ 级别的，所以指针暴力移动就好了。每次要便历一个块时下传一下 $tag$ 就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e5</span><span class="hljs-number">+6</span>,M=<span class="hljs-number">405</span>,mod=<span class="hljs-number">998244353</span>;<br><span class="hljs-type">int</span> n,m,len=<span class="hljs-number">320</span>,lst[N],vis[N],L[M],R[M];<br><span class="hljs-type">int</span> f[N],suf[N],p[M],tag[M],ton[M][N],sum[M];<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	x+=y;<br>	<span class="hljs-keyword">if</span>(x&gt;=mod) x-=mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Sub</span><span class="hljs-params">(<span class="hljs-type">int</span> &amp;x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	x-=y;<br>	<span class="hljs-keyword">if</span>(x&lt;<span class="hljs-number">0</span>) x+=mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> l=<span class="hljs-number">0</span>,r=len<span class="hljs-number">-1</span>,cnt;<br>	<span class="hljs-keyword">while</span>(r&lt;n)<br>	&#123;<br>		L[++cnt]=l;R[cnt]=r;<br>		l=r<span class="hljs-number">+1</span>;r+=len;<br>	&#125;<br>	L[++cnt]=l;R[cnt]=n;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span><br><span class="hljs-function"></span>&#123;<br>	sum[k]=<span class="hljs-number">0</span>;p[k]=m;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=L[k];i&lt;=R[k];i++)<br>	&#123;<br>		<span class="hljs-built_in">Sub</span>(ton[k][suf[i]],f[i]);<br>		suf[i]+=tag[k];<br>		<span class="hljs-built_in">Add</span>(ton[k][suf[i]],f[i]);<br>		<span class="hljs-keyword">if</span>(suf[i]&lt;=m) <span class="hljs-built_in">Add</span>(sum[k],f[i]);<br>	&#125;<br>	tag[k]=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add_tag</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	tag[k]+=val;<br>	<span class="hljs-keyword">if</span>(val&gt;<span class="hljs-number">0</span>)<br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=val;i++)<br>			<span class="hljs-built_in">Sub</span>(sum[k],ton[k][p[k]]),p[k]--;<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">-1</span>;i&gt;=val;i--)<br>			p[k]++,<span class="hljs-built_in">Add</span>(sum[k],ton[k][p[k]]);<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> k=x/len<span class="hljs-number">+1</span>;<br>	<span class="hljs-built_in">Add</span>(ton[k][suf[x]],f[x]);<br>	<span class="hljs-keyword">if</span>(suf[x]&lt;=m) <span class="hljs-built_in">Add</span>(sum[k],f[x]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> val)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x==<span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> ;<br>	<span class="hljs-type">int</span> k=x/len<span class="hljs-number">+1</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;k;i++) <span class="hljs-built_in">Add_tag</span>(i,val);<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=L[k];i&lt;=x;i++)<br>	&#123;<br>		<span class="hljs-built_in">Sub</span>(ton[k][suf[i]],f[i]);<br>		<span class="hljs-keyword">if</span>(suf[i]&lt;=m) <span class="hljs-built_in">Sub</span>(sum[k],f[i]);<br>		suf[i]+=val;<br>		<span class="hljs-built_in">Add</span>(ton[k][suf[i]],f[i]);<br>		<span class="hljs-keyword">if</span>(suf[i]&lt;=m) <span class="hljs-built_in">Add</span>(sum[k],f[i]);<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> k=x/len<span class="hljs-number">+1</span>,res=<span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;k;i++) <span class="hljs-built_in">Add</span>(res,sum[i]);<br>	<span class="hljs-built_in">pushdown</span>(k);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=L[k];i&lt;x;i++)<br>		<span class="hljs-keyword">if</span>(suf[i]&lt;=m) <span class="hljs-built_in">Add</span>(res,f[i]);<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;m);<br>	<span class="hljs-built_in">init</span>();<br>	f[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;suf[<span class="hljs-number">0</span>]=<span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">insert</span>(<span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;x);<br>		<span class="hljs-built_in">modify</span>(i<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>);<span class="hljs-built_in">modify</span>(lst[vis[x]]<span class="hljs-number">-1</span>,<span class="hljs-number">1</span>);<span class="hljs-built_in">modify</span>(vis[x]<span class="hljs-number">-1</span>,<span class="hljs-number">-2</span>);<br>		lst[i]=vis[x];vis[x]=i;<br>		f[i]=<span class="hljs-built_in">query</span>(i);<br>		<span class="hljs-built_in">insert</span>(i);<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,f[n]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1167F-Scalar-Queries"><a href="#CF1167F-Scalar-Queries" class="headerlink" title="CF1167F Scalar Queries"></a>CF1167F Scalar Queries</h2><p>感觉难度适中</p>
<p>直接求很难，我们考虑算每个点的贡献。答案就是 $\sum\limits_{i&#x3D;1}^n a_i\times\sum\limits_{k&#x3D;1}^nk\times f(i,k)$ 。 $f(i,k)$ 是第 $i$个数 作为区间第 $k$ 小的区间个数。想一下我们就会发现 $\sum\limits_{k&#x3D;1}^n k\times f(a_i,k)$ ，其实等价于所有包含第 $i$ 个数的区间中小于等于 $a_i$ 的数的个数之和。我们设这个值是 $g(i)$ 。</p>
<p>我们现在考虑把数从小到大考虑，那其实就等价于每次把一个位置的 $0$ 变成 $1$ ,把一个区间的 $val$ 定义为他所包含的 $1$ 的个数。那么 $g(i)$ 就是所有包含第 $i$ 个数的区间权值之和。包含第 $i$ 个数的条件通过容斥变成：所有区间的权值和 $-$ 不包含第 $i$ 个数的区间的权值和。</p>
<p>所以我们现在要算的就是 $[l,r]$ 之内所有区间的权值和。我们考虑分治，先算<br>$[l,mid]$ 和 $[mid+1,r]$ 的权值和，在算经过 $mid$ 的区间的权值和。</p>
<p>我们设 $pre$ 是前缀区间的权值和， $suf$ 是后缀区间的权值和。 那么这一部分权值和 $suf_{[l,mid]}\times (r-mid)+pre_{[mid+1,r]}\times(mid-l+1)$ 。</p>
<p>把这玩意放在线段树上面，每次单点修改，区间查询就好了。</p>
<p>最后想一下 $pre$  和 $suf$ 的 $pushup$ ，其实也不难。我们设 $s$ 是区间中 $1$ 的个数。</p>
<p>$pre_{[l,r]}&#x3D;pre_{[l,mid]}+s_{[l,mid]}\times(r-mid)+pre_{[mid+1,r]}$</p>
<p>$suf_{[l,r]}&#x3D;suf_{[mid+1,r]}+s_{[mid+1,r]}\times(mid-l+1)+suf_{[l,mid]}$</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">5e5</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">1e9</span><span class="hljs-number">+7</span>;<br><span class="hljs-type">int</span> n,a[N],id[N],ans;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span><br>&#123;<br>	<span class="hljs-type">int</span> l,r;<br>	<span class="hljs-type">int</span> pre,suf,s,sum;<br>&#125;t[N&lt;&lt;<span class="hljs-number">2</span>];<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<span class="hljs-keyword">return</span> a[x]&lt;a[y];&#125;<br><br><span class="hljs-function">node <span class="hljs-title">pushup</span><span class="hljs-params">(node lc,node rc)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> l=lc.l,r=rc.r;<br>	<span class="hljs-type">int</span> mid=lc.r;<br>	node c;<br>	c.l=l;c.r=r;<br>	c.s=lc.s+rc.s;<br>	c.sum=(lc.sum+rc.sum)%mod;<br>	c.sum=(c.sum<span class="hljs-number">+1ll</span>*lc.suf*(r-mid)%mod)%mod;<br>	c.sum=(c.sum<span class="hljs-number">+1ll</span>*rc.pre*(mid-l<span class="hljs-number">+1</span>)%mod)%mod;<br>	c.pre=(lc.pre<span class="hljs-number">+1ll</span>*lc.s*(r-mid)%mod+rc.pre)%mod;<br>	c.suf=(rc.suf<span class="hljs-number">+1ll</span>*rc.s*(mid-l<span class="hljs-number">+1</span>)%mod+lc.suf)%mod;<br>	<span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span><br><span class="hljs-function"></span>&#123;<br>	t[k].l=l;t[k].r=r;<br>	<span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span>;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid);<span class="hljs-built_in">build</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(l==r)<br>	&#123;<br>		t[k].sum=t[k].s=t[k].pre=t[k].suf=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">return</span> ;<br>	&#125;<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x);<br>	<span class="hljs-keyword">else</span> <span class="hljs-built_in">modify</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x);<br>	t[k]=<span class="hljs-built_in">pushup</span>(t[k&lt;&lt;<span class="hljs-number">1</span>],t[k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>]);<br>&#125;<br><br><span class="hljs-function">node <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;=l&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> t[k];<br>	<span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">if</span>(y&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y);<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(x&gt;mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y);<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">pushup</span>(<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>,l,mid,x,y),<span class="hljs-built_in">query</span>(k&lt;&lt;<span class="hljs-number">1</span>|<span class="hljs-number">1</span>,mid<span class="hljs-number">+1</span>,r,x,y));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;a[i]),id[i]=i;<br>	<span class="hljs-built_in">sort</span>(id<span class="hljs-number">+1</span>,id<span class="hljs-number">+1</span>+n,cmp);<br>	<span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,id[i]);<br>		<span class="hljs-type">int</span> res=t[<span class="hljs-number">1</span>].sum;<br>		<span class="hljs-keyword">if</span>(id[i]&gt;<span class="hljs-number">1</span>) res=(res+mod-<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,<span class="hljs-number">1</span>,id[i]<span class="hljs-number">-1</span>).sum)%mod;<br>		<span class="hljs-keyword">if</span>(id[i]&lt;n) res=(res+mod-<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,id[i]<span class="hljs-number">+1</span>,n).sum)%mod;<br>		ans=(ans<span class="hljs-number">+1ll</span>*a[id[i]]*res%mod)%mod;<br>	&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d&quot;</span>,ans);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h2 id="CF1748D-ConstructOR"><a href="#CF1748D-ConstructOR" class="headerlink" title="CF1748D ConstructOR"></a>CF1748D ConstructOR</h2><p>真的不会数论构造题。。。</p>
<p>我们考虑特殊的一个 $x$ ，满足 $x|a&#x3D;x|b&#x3D;x$ ，且  $d$ 整除 $x$ 。所以现在我们直接把 $a&#x3D;a|b$ 。</p>
<p>首先无解的情况肯定是 $lowbit(a)&lt;lowbit(d)$ 。我们设 $lowbit(d)&#x3D;2^k$ ， $d&#x3D;2^k\cdot d’$ , $x_{(2)}&#x3D;p\ 1 \dots 1 0\dots 0$。那么。 $x&#x3D;2^k\cdot(p \cdot 2^{30-k}+(2^{30-k}-1))$ 。</p>
<p>$\ \ \ \ \  2^k\cdot(p\cdot2^{30-k}+2^{30-k}-1)\equiv 0 \pmod{ 2^k \cdot d’} $</p>
<p>$\leftrightarrow p\cdot2^{30-k}+2^{30-k}+1\equiv 0\pmod{d’}$</p>
<p>$\leftrightarrow p\equiv (\frac{1}{2})^{30-k} -1\pmod{d’}$</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">int</span> T,k;<br>ll a,b,c,d;<br><br><span class="hljs-function">ll <span class="hljs-title">lowbit</span><span class="hljs-params">(ll x)</span></span>&#123;<span class="hljs-keyword">return</span> x&amp;(-x);&#125;<br><span class="hljs-function">ll <span class="hljs-title">qsm</span><span class="hljs-params">(ll A,ll B,ll mod)</span></span><br><span class="hljs-function"></span>&#123;<br>	ll res=<span class="hljs-number">1</span>;<br>	<span class="hljs-keyword">for</span>(;B;B&gt;&gt;=<span class="hljs-number">1</span>)<br>	&#123;<br>		<span class="hljs-keyword">if</span>(B&amp;<span class="hljs-number">1</span>) res=A*res%mod;<br>		A=A*A%mod;<br>	&#125;<br>	<span class="hljs-keyword">return</span> res;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;T);<br>	<span class="hljs-keyword">while</span>(T--)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld%lld%lld&quot;</span>,&amp;a,&amp;b,&amp;c);<br>		a|=b;<br>		<span class="hljs-keyword">if</span>(a%<span class="hljs-built_in">lowbit</span>(c)) <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;-1&quot;</span>);<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			ll x=(<span class="hljs-number">1ll</span>&lt;&lt;<span class="hljs-number">30</span>)-<span class="hljs-built_in">lowbit</span>(c),p;<br>			d=<span class="hljs-built_in">lowbit</span>(c);<br>			c/=d;<br>			k=<span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">while</span>(d%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>) d&gt;&gt;=<span class="hljs-number">1</span>,k++;<br>			p=(<span class="hljs-built_in">qsm</span>((c<span class="hljs-number">+1</span>)/<span class="hljs-number">2</span>,<span class="hljs-number">30</span>-k,c)+c<span class="hljs-number">-1</span>)%c;<br>			x+=p&lt;&lt;<span class="hljs-number">30</span>;<br>			<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,x);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1163F-Indecisive-Taxi-Fee"><a href="#CF1163F-Indecisive-Taxi-Fee" class="headerlink" title="CF1163F Indecisive Taxi Fee"></a>CF1163F Indecisive Taxi Fee</h2><p>删边最短路 <del>（别人说很典，反正我是不会）</del> 。</p>
<p>考虑原本图上的最短路路径是 $path$ ，那么修改一条边 $t$ 就有两种情况。<br>设 $del_t$ 是不经过 $t$ 的最短路。</p>
<ul>
<li>$t\in path$ ， $ans&#x3D;min(del_t,dis_{1\rightarrow n}+x-w_t)$</li>
<li>$t\notin path$ ，$ans&#x3D;min(dis_{1\rightarrow n},dis_{1\rightarrow a_t}+dis_{b_i\rightarrow n}+x-w_t)$</li>
</ul>
<p>唯一难搞的就只有 $del_t$ 了。但我太菜了，所以就挂 <a target="_blank" rel="noopener" href="https://www.luogu.com.cn/blog/Chenxiao-Yan/solution-cf1163f">别人的</a> 吧。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;vector&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;algorithm&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;queue&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;set&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstring&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pb push_back</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> fir first</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> sec second</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> mkp make_pair</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">2e5</span><span class="hljs-number">+5</span>;<br><span class="hljs-type">int</span> n,m,q,tot,vis[N],fr[N];<br><span class="hljs-type">int</span> head[N],nex[N&lt;&lt;<span class="hljs-number">1</span>],v[N&lt;&lt;<span class="hljs-number">1</span>],w[N&lt;&lt;<span class="hljs-number">1</span>];<br><span class="hljs-type">int</span> a[N],b[N],c[N],ord[N],id[N];<br><span class="hljs-type">int</span> pre[N],suf[N];<br>ll inf=<span class="hljs-number">1e18</span>,d1[N],dn[N],Del[N];<br>vector&lt;<span class="hljs-type">int</span>&gt;son[N],path;<br>vector&lt;ll&gt;add[N],del[N];<br>multiset&lt;ll&gt;st;<br><br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmp1</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<span class="hljs-keyword">return</span> d1[x]&lt;d1[y];&#125;<br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">cmpn</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>&#123;<span class="hljs-keyword">return</span> dn[x]&lt;dn[y];&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Add</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> z)</span></span><br><span class="hljs-function"></span>&#123;<br>	nex[++tot]=head[x];<br>	head[x]=tot;<br>	v[tot]=y;w[tot]=z;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Dij</span><span class="hljs-params">(<span class="hljs-type">int</span> s,ll d[])</span></span><br><span class="hljs-function"></span>&#123;<br>	priority_queue&lt;pair&lt;ll,<span class="hljs-type">int</span>&gt; &gt;qu;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) d[i]=inf,vis[i]=<span class="hljs-number">0</span>;<br>	d[s]=<span class="hljs-number">0</span>;<br>	qu.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">mkp</span>(<span class="hljs-number">0</span>,s));<br>	<span class="hljs-keyword">while</span>(!qu.<span class="hljs-built_in">empty</span>())<br>	&#123;<br>		<span class="hljs-type">int</span> x=qu.<span class="hljs-built_in">top</span>().sec;qu.<span class="hljs-built_in">pop</span>();<br>		<span class="hljs-keyword">if</span>(vis[x]) <span class="hljs-keyword">continue</span>;<br>		vis[x]=<span class="hljs-number">1</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>		&#123;<br>			<span class="hljs-type">int</span> y=v[i];<br>			<span class="hljs-keyword">if</span>(d[y]&gt;d[x]+w[i])<br>			&#123;<br>				d[y]=d[x]+w[i];<br>				qu.<span class="hljs-built_in">push</span>(<span class="hljs-built_in">mkp</span>(-d[y],y));<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> lst,<span class="hljs-type">int</span> p[])</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(~id[x]) lst=id[x];<br>	p[x]=lst;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;son[x].<span class="hljs-built_in">size</span>();i++) <span class="hljs-built_in">dfs</span>(son[x][i],lst,p);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-type">int</span> x,t;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;n,&amp;m,&amp;q);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d%d&quot;</span>,&amp;a[i],&amp;b[i],&amp;c[i]);<br>		<span class="hljs-built_in">Add</span>(a[i],b[i],c[i]);<span class="hljs-built_in">Add</span>(b[i],a[i],c[i]);<br>	&#125;<br>	<span class="hljs-built_in">Dij</span>(<span class="hljs-number">1</span>,d1);<span class="hljs-built_in">Dij</span>(n,dn);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) ord[i]=i;<br>	<span class="hljs-built_in">sort</span>(ord<span class="hljs-number">+1</span>,ord<span class="hljs-number">+1</span>+n,cmp1);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> _i=<span class="hljs-number">2</span>;_i&lt;=n;_i++)<br>	&#123;<br>		x=ord[_i];<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>			<span class="hljs-keyword">if</span>(d1[v[i]]+w[i]==d1[x]) <br>			&#123;<br>				fr[x]=v[i];<br>				son[v[i]].<span class="hljs-built_in">pb</span>(x);<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>	&#125;<br>	x=n;<br>	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) <br>	&#123;<br>    	path.<span class="hljs-built_in">pb</span>(x);<br>		<span class="hljs-keyword">if</span>(x==<span class="hljs-number">1</span>) <span class="hljs-keyword">break</span>;<br>		x=fr[x];<br>	&#125;<br>	<span class="hljs-built_in">reverse</span>(path.<span class="hljs-built_in">begin</span>(),path.<span class="hljs-built_in">end</span>());<br>	<span class="hljs-built_in">memset</span>(id,<span class="hljs-number">-1</span>,<span class="hljs-built_in">sizeof</span>(id));<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;path.<span class="hljs-built_in">size</span>();i++) id[path[i]]=i;<br>	<span class="hljs-built_in">dfs</span>(<span class="hljs-number">1</span>,<span class="hljs-number">-1</span>,pre);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) son[i].<span class="hljs-built_in">clear</span>();<br>	<span class="hljs-built_in">sort</span>(ord<span class="hljs-number">+1</span>,ord<span class="hljs-number">+1</span>+n,cmpn);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> _i=<span class="hljs-number">2</span>;_i&lt;=n;_i++)<br>	&#123;<br>		x=ord[_i];<br>		<span class="hljs-keyword">if</span>(~id[x])<br>		&#123;<br>			son[path[id[x]<span class="hljs-number">+1</span>]].<span class="hljs-built_in">pb</span>(x);<br>			<span class="hljs-keyword">continue</span>;<br>		&#125;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=head[x];i;i=nex[i])<br>			<span class="hljs-keyword">if</span>(dn[v[i]]+w[i]==dn[x])<br>			&#123;<br>				son[v[i]].<span class="hljs-built_in">pb</span>(x);<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>	&#125;<br>	<span class="hljs-built_in">dfs</span>(n,<span class="hljs-number">-1</span>,suf);<br>	<span class="hljs-built_in">memset</span>(vis,<span class="hljs-number">-1</span>,<span class="hljs-built_in">sizeof</span>(vis));<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i<span class="hljs-number">+1</span>&lt;path.<span class="hljs-built_in">size</span>();i++)<br>	&#123;<br>		x=path[i];t=path[i<span class="hljs-number">+1</span>];<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> _i=head[x];_i;_i=nex[_i])<br>			<span class="hljs-keyword">if</span>(v[_i]==t&amp;&amp;d1[x]+w[_i]==d1[t]) vis[(_i<span class="hljs-number">+1</span>)&gt;&gt;<span class="hljs-number">1</span>]=i;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++)<br>		<span class="hljs-keyword">if</span>(!(~vis[i]))<br>		&#123;<br>			<span class="hljs-type">int</span> l=pre[a[i]],r=suf[b[i]];<br>			ll val=d1[a[i]]+dn[b[i]]+c[i];<br>			<span class="hljs-keyword">if</span>(l&lt;r) add[l].<span class="hljs-built_in">pb</span>(val),del[r].<span class="hljs-built_in">pb</span>(val);<br>			l=pre[b[i]];r=suf[a[i]];<br>			val=d1[b[i]]+dn[a[i]]+c[i];<br>			<span class="hljs-keyword">if</span>(l&lt;r) add[l].<span class="hljs-built_in">pb</span>(val),del[r].<span class="hljs-built_in">pb</span>(val);<br>		&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i<span class="hljs-number">+1</span>&lt;path.<span class="hljs-built_in">size</span>();i++)<br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;add[i].<span class="hljs-built_in">size</span>();j++) st.<span class="hljs-built_in">insert</span>(add[i][j]);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;del[i].<span class="hljs-built_in">size</span>();j++) st.<span class="hljs-built_in">erase</span>(st.<span class="hljs-built_in">find</span>(del[i][j]));<br>		Del[i]=st.<span class="hljs-built_in">empty</span>()? inf:*st.<span class="hljs-built_in">begin</span>();<br>	&#125;<br>	<span class="hljs-keyword">while</span>(q--)<br>	&#123;<br>		<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;t,&amp;x);<br>		<span class="hljs-keyword">if</span>(~vis[t]) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-built_in">min</span>(Del[vis[t]],d1[n]-c[t]+x));<br>		<span class="hljs-keyword">else</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,<span class="hljs-built_in">min</span>(d1[n],<span class="hljs-built_in">min</span>(d1[a[t]]+dn[b[t]]+x,d1[b[t]]+dn[a[t]]+x)));<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1761D-Carry-Bit"><a href="#CF1761D-Carry-Bit" class="headerlink" title="CF1761D Carry Bit"></a>CF1761D Carry Bit</h2><p>我们考虑进位发生在什么情况下。那就是一段区间他的第一个位置两个都是 $1$ ，剩下的位置至少有一个是 $1$ ，所以一段长度为 $len$ 的区间，他的方案数是 $3^{len-1}$ 。对于没有进制的区间，如果他的上一个区间是有进为的区间，那么他的第一个位置的两个数都是 $0$ ,否则就不是强制两个数都是 $0$ 。对于剩下的位置两个数中至多有一个 $1$ ，方案数就是 $3^{len-1}$ 或者 $3^{len}$ 。</p>
<p>那么我们考虑没有进位区间的段数。考虑但前被分成了 $i$ 段，然后把 $k$ 个进位放在这些区间。这样只就有了四种情况。</p>
<ul>
<li><p>区间的两边都不填数，方案数就是 ${n-k-1\choose i-1}{k-1\choose i-2}\times3^{n-k-i+1}\times3^{k-i+1}$</p>
</li>
<li><p>区间的两边只有左边填数，方案数就是 ${n-k-1\choose i-1}{k-1\choose i-1}\times 3^{n-k-i+1}\times3^{k-i}$</p>
</li>
<li><p>区间的两边只有右边填数，方案数就是 ${n-k-1\choose i-1}{k-1\choose i-1}\times 3^{n-k-i}\times3^{k-i}$</p>
</li>
<li><p>区间的两边都填数，方案数就是 ${n-k-i\choose i-1}{k-1\choose i}\times3^{n-k-i}\times3^{k-i-1}$</p>
</li>
</ul>
<p>然而我赛后 $FST$ 了，没有与处理幂次被卡常了，含泪掉大分，所以就有了这篇题解。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">1e6</span><span class="hljs-number">+5</span>,mod=<span class="hljs-number">1e9</span><span class="hljs-number">+7</span>;<br><span class="hljs-type">int</span> n,k,ans,fac[N],inv[N],pw[N];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">qsm</span><span class="hljs-params">(<span class="hljs-type">int</span> b)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(b&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> pw[b];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">C</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span>(x&lt;y||x&lt;<span class="hljs-number">0</span>||y&lt;<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">1ll</span>*fac[x]*inv[y]%mod*inv[x-y]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	pw[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">0</span>]=inv[<span class="hljs-number">1</span>]=fac[<span class="hljs-number">0</span>]=fac[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;<br>	pw[<span class="hljs-number">1</span>]=<span class="hljs-number">3</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n;i++)<br>	&#123;<br>		fac[i]=<span class="hljs-number">1ll</span>*fac[i<span class="hljs-number">-1</span>]*i%mod;<br>		inv[i]=<span class="hljs-number">1ll</span>*(mod-mod/i)*inv[mod%i]%mod;<br>		pw[i]=<span class="hljs-number">3ll</span>*pw[i<span class="hljs-number">-1</span>]%mod;<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=n;i++) inv[i]=<span class="hljs-number">1ll</span>*inv[i<span class="hljs-number">-1</span>]*inv[i]%mod;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d%d&quot;</span>,&amp;n,&amp;k);<br>	<span class="hljs-built_in">init</span>();<br>	<span class="hljs-keyword">if</span>(k==n) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">qsm</span>(n<span class="hljs-number">-1</span>));<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(!k) <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,<span class="hljs-built_in">qsm</span>(n));<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n-k;i++)<br>		&#123;<br>			<span class="hljs-type">int</span> g=<span class="hljs-built_in">C</span>(n-k<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>);<br>			ans=(ans<span class="hljs-number">+1ll</span>*g*<span class="hljs-built_in">C</span>(k<span class="hljs-number">-1</span>,i<span class="hljs-number">-2</span>)%mod*<span class="hljs-built_in">qsm</span>(n-k-i<span class="hljs-number">+1</span>)%mod*<span class="hljs-built_in">qsm</span>(k-i<span class="hljs-number">+1</span>)%mod)%mod;<br>			ans=(ans<span class="hljs-number">+1ll</span>*g*<span class="hljs-built_in">C</span>(k<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>)%mod*<span class="hljs-built_in">qsm</span>(n-k-i<span class="hljs-number">+1</span>)%mod*<span class="hljs-built_in">qsm</span>(k-i)%mod)%mod;<br>			ans=(ans<span class="hljs-number">+1ll</span>*g*<span class="hljs-built_in">C</span>(k<span class="hljs-number">-1</span>,i<span class="hljs-number">-1</span>)%mod*<span class="hljs-built_in">qsm</span>(n-k-i)%mod*<span class="hljs-built_in">qsm</span>(k-i)%mod)%mod;<br>			ans=(ans<span class="hljs-number">+1ll</span>*g*<span class="hljs-built_in">C</span>(k<span class="hljs-number">-1</span>,i)%mod*<span class="hljs-built_in">qsm</span>(n-k-i)%mod*<span class="hljs-built_in">qsm</span>(k-i<span class="hljs-number">-1</span>)%mod)%mod;<br>			<span class="hljs-keyword">if</span>(i<span class="hljs-number">-1</span>&gt;k) <span class="hljs-keyword">break</span>;<br>		&#125;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>,ans);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="CF1107E-Vasya-and-Binary-String"><a href="#CF1107E-Vasya-and-Binary-String" class="headerlink" title="CF1107E Vasya and Binary String"></a>CF1107E Vasya and Binary String</h2><p>考虑 $dp_{i,j}$ 为 区间 $[i,j]$ 的数全被消完的最大权值。</p>
<p>但这样子并不好搞，所以我们多加一维。 $dp_{i,j,k}$ 表示区间 $[i,j]$ 和 $j$ 往后 $k$ 个与 $j$ 相同的数被消完的最大值。那么转移就有两种情况。</p>
<ul>
<li><p>$dp_{i,j,k}&#x3D;dp_{i,j-1,0}+v_{k+1}$ （把 $[i,j-1]$ 消完再加上 $k+1$ 个数）</p>
</li>
<li><p>$dp_{i,j,t}&#x3D;dp_{i,k,t+1}+dp_{k+1,j-1,0}$  （先把 $[k+1,j-1]$ 消完，再消剩下的，要保证 $c_k&#x3D;c_j$ ）</p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;cstdio&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ll long long</span><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;<br><br><span class="hljs-type">const</span> <span class="hljs-type">int</span> N=<span class="hljs-number">105</span>;<br><span class="hljs-type">int</span> n,c[N],sum[N];<br>ll v[N],f[N][N][N];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;n);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%1d&quot;</span>,&amp;c[i]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%lld&quot;</span>,&amp;v[i]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++)<br>	&#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i<span class="hljs-number">+1</span>;j&lt;=n;j++) sum[i]+=(c[i]==c[j]);<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;i;j++) v[i]=<span class="hljs-built_in">max</span>(v[i],v[j]+v[i-j]);<br>	&#125;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=n;i;i--)<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i;j&lt;=n;j++)<br>		&#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=i;k&lt;j;k++)<br>				<span class="hljs-keyword">if</span>(c[j]==c[k])<br>				&#123;<br>					<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> t=<span class="hljs-number">0</span>;t&lt;=sum[j];t++)<br>						f[i][j][t]=<span class="hljs-built_in">max</span>(f[i][j][t],f[i][k][t<span class="hljs-number">+1</span>]+f[k<span class="hljs-number">+1</span>][j<span class="hljs-number">-1</span>][<span class="hljs-number">0</span>]);<br>				&#125;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;=sum[j];k++) f[i][j][k]=<span class="hljs-built_in">max</span>(f[i][j][k],f[i][j<span class="hljs-number">-1</span>][<span class="hljs-number">0</span>]+v[k<span class="hljs-number">+1</span>]);<br>		&#125;<br>	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%lld\n&quot;</span>,f[<span class="hljs-number">1</span>][n][<span class="hljs-number">0</span>]);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/06/23/Vector%20Algebra/" title="Vector Algebra">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Vector Algebra</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/06/22/blog%20%E6%97%A5%E5%BF%97/" title="Mikasa blog 日志">
                        <span class="hidden-mobile">Mikasa blog 日志</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  var relativeDate = function() {
    var updatedTime = document.getElementById('updated-time');
    if (updatedTime) {
      var text = updatedTime.textContent;
      var reg = /\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:Z|[+-]\d{2}:\d{2})/;
      var matchs = text.match(reg);
      if (matchs) {
        var relativeTime = moment(matchs[0]).fromNow();
        updatedTime.textContent = text.replace(reg, relativeTime);
      }
      updatedTime.style.display = '';
    }
  };
  Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/moment.min.js', function() {
    if (!'zh-cn'.startsWith('en')) {
      Fluid.utils.createScript('https://lib.baomitu.com/moment.js/2.29.4/locale/zh-cn.min.js', function() {
        relativeDate();
      });
    } else {
      relativeDate();
    }
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
